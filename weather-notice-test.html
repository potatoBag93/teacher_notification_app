<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>날씨 기반 Notice 테스트</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .weather-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .notice-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #2196F3;
        }
        
        .notice-card.priority-1 {
            border-left-color: #f44336;
            background-color: #ffebee;
        }
        
        .notice-card.priority-2 {
            border-left-color: #ff9800;
            background-color: #fff3e0;
        }
        
        .notice-card.priority-3 {
            border-left-color: #4caf50;
            background-color: #e8f5e8;
        }
        
        .notice-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .notice-content {
            font-size: 14px;
            line-height: 1.6;
            color: #555;
        }
        
        .notice-meta {
            font-size: 12px;
            color: #888;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
        }
        
        .priority-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .priority-1 .priority-badge {
            background: #f44336;
            color: white;
        }
        
        .priority-2 .priority-badge {
            background: #ff9800;
            color: white;
        }
        
        .priority-3 .priority-badge {
            background: #4caf50;
            color: white;
        }
        
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #1976D2;
        }
        
        .loading {
            text-align: center;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌤️ 날씨 기반 공지사항 생성 시스템</h1>
        
        <div>
            <h3>테스트 위치</h3>
            <button onclick="testLocation(37.5665, 126.9780, '서울시청')">서울시청</button>
            <button onclick="testLocation(35.1595, 129.0596, '부산시청')">부산시청</button>
            <button onclick="testLocation(35.8714, 128.6014, '대구시청')">대구시청</button>
            <button onclick="testDummyWeather()">더미 데이터 테스트</button>
        </div>
        
        <div id="result"></div>
    </div>

    <script>
        const API_URL = 'https://your-supabase-project.supabase.co/functions/v1/get-weather-by-grid';
        
        async function testLocation(lat, lng, name) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="loading">날씨 데이터와 공지사항을 생성 중...</div>';
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lat: lat,
                        lng: lng,
                        address: name
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayResult(data.weather, name);
                } else {
                    resultDiv.innerHTML = `<div class="error">오류: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">네트워크 오류: ${error.message}</div>`;
            }
        }
        
        function testDummyWeather() {
            // 다양한 더미 날씨 데이터로 테스트
            const dummyScenarios = [
                {
                    name: "극한 폭염 + 고습도",
                    weather: {
                        temperature: 38,
                        humidity: 90,
                        precipitation: 0,
                        windSpeed: 3,
                        skyCondition: 'clear',
                        skyDescription: '맑음',
                        precipitationType: 'none',
                        precipitationDescription: '없음',
                        notices: []
                    }
                },
                {
                    name: "한파 + 강풍 + 눈",
                    weather: {
                        temperature: -5,
                        humidity: 70,
                        precipitation: 8,
                        windSpeed: 15,
                        skyCondition: 'snowy',
                        skyDescription: '눈',
                        precipitationType: 'snow',
                        precipitationDescription: '눈',
                        notices: []
                    }
                },
                {
                    name: "집중호우 + 강풍",
                    weather: {
                        temperature: 25,
                        humidity: 95,
                        precipitation: 35,
                        windSpeed: 12,
                        skyCondition: 'rainy',
                        skyDescription: '비',
                        precipitationType: 'rain',
                        precipitationDescription: '비',
                        notices: []
                    }
                },
                {
                    name: "완벽한 날씨",
                    weather: {
                        temperature: 22,
                        humidity: 55,
                        precipitation: 0,
                        windSpeed: 2,
                        skyCondition: 'clear',
                        skyDescription: '맑음',
                        precipitationType: 'none',
                        precipitationDescription: '없음',
                        notices: []
                    }
                }
            ];
            
            // 랜덤으로 시나리오 선택
            const randomScenario = dummyScenarios[Math.floor(Math.random() * dummyScenarios.length)];
            
            // Notice 생성 시뮬레이션 (실제로는 API에서 생성됨)
            const mockNotices = generateMockNotices(randomScenario.weather);
            randomScenario.weather.notices = mockNotices;
            
            // 더미 데이터 추가
            randomScenario.weather.date = new Date().toISOString().split('T')[0];
            randomScenario.weather.time = new Date().getHours().toString().padStart(2, '0') + '00';
            randomScenario.weather.gridX = 60;
            randomScenario.weather.gridY = 127;
            randomScenario.weather.address = `테스트 지역 (${randomScenario.name})`;
            
            displayResult(randomScenario.weather, randomScenario.name);
        }
        
        // Mock Notice 생성 함수 (실제 weather-notices.ts 로직 시뮬레이션)
        function generateMockNotices(weather) {
            const notices = [];
            const mockNoticesDB = {
                hot: [
                    {
                        title: "폭염 경보 - 야외활동 전면 금지",
                        content: "기상청에서 폭염 경보를 발령했습니다. 모든 야외 수업과 활동을 중단하고 실내에서 진행해 주시기 바랍니다.",
                        category: "안전", priority: 1, icon: "🚨"
                    },
                    {
                        title: "무더위 대비 학생 건강관리 협조 요청",
                        content: "연일 계속되는 무더위로 학생들의 컨디션 난조가 우려됩니다. 교실 온도 체크를 자주 해주시고, 학생들이 어지러움이나 메스꺼움을 호소할 경우 즉시 보건실로 안내해 주시기 바랍니다.",
                        category: "건강", priority: 1, icon: "🏥"
                    }
                ],
                cold: [
                    {
                        title: "한파 경보 - 실외 활동 전면 중단",
                        content: "기상청에서 한파 경보를 발령했습니다. 모든 실외 수업과 활동을 중단하고 실내에서만 진행해 주시기 바랍니다.",
                        category: "안전", priority: 1, icon: "❄️"
                    }
                ],
                heavy_rain: [
                    {
                        title: "집중호우 경보 - 침수 지역 우회 안내",
                        content: "시간당 20mm 이상의 폭우가 내리고 있습니다. 학교 주변 침수 위험 지역을 파악하시고, 안전한 등하교 경로를 학생들에게 안내해 주시기 바랍니다.",
                        category: "안전", priority: 1, icon: "🌊"
                    }
                ],
                rain: [
                    {
                        title: "우천 시 우산 지참 및 안전 귀가 지도",
                        content: "오늘 하루 종일 비가 예상됩니다. 학생들이 우산을 준비했는지 확인해 주시고, 하교 시 미끄러운 길면에서의 안전사고 예방을 위한 주의사항을 당부해 주시기 바랍니다.",
                        category: "안전", priority: 2, icon: "☔"
                    }
                ],
                snow: [
                    {
                        title: "대설 주의보 - 교내 빙판길 안전사고 예방",
                        content: "눈이 내려 교내에 빙판길이 형성될 수 있습니다. 학생들에게 천천히 걷기를 지도해 주시고, 계단이나 경사로에서는 특히 주의하도록 안내해 주시기 바랍니다.",
                        category: "안전", priority: 1, icon: "⛄"
                    }
                ],
                wind: [
                    {
                        title: "강풍 주의보 - 야외활동 전면 금지",
                        content: "풍속 10m/s 이상의 강풍이 예상됩니다. 모든 야외활동을 중단하고 실내로 대피시켜 주시기 바랍니다.",
                        category: "안전", priority: 1, icon: "💨"
                    }
                ],
                humid: [
                    {
                        title: "고습도 주의 - 교실 제습 및 환기 관리",
                        content: "습도가 80% 이상으로 매우 높습니다. 제습기를 가동하고 자주 환기를 실시해 주시기 바랍니다.",
                        category: "생활", priority: 2, icon: "💧"
                    }
                ],
                normal: [
                    {
                        title: "쾌적한 날씨 - 야외 교육활동 추천",
                        content: "오늘은 야외활동하기 좋은 날씨입니다. 자연 관찰, 운동장 체육활동, 산책 등을 통해 학생들이 자연과 함께할 수 있는 시간을 가져보시기 바랍니다.",
                        category: "학교활동", priority: 3, icon: "🌤️"
                    }
                ]
            };
            
            const today = new Date().toISOString().split('T')[0];
            
            // 온도 조건
            if (weather.temperature >= 35) {
                notices.push(...mockNoticesDB.hot.map(n => ({...n, date: today})));
            } else if (weather.temperature <= 0) {
                notices.push(...mockNoticesDB.cold.map(n => ({...n, date: today})));
            }
            
            // 강수 조건
            if (weather.precipitation >= 20) {
                notices.push(...mockNoticesDB.heavy_rain.map(n => ({...n, date: today})));
            } else if (weather.precipitation > 0) {
                if (weather.precipitationType === 'snow') {
                    notices.push(...mockNoticesDB.snow.map(n => ({...n, date: today})));
                } else {
                    notices.push(...mockNoticesDB.rain.map(n => ({...n, date: today})));
                }
            }
            
            // 풍속 조건
            if (weather.windSpeed >= 10) {
                notices.push(...mockNoticesDB.wind.map(n => ({...n, date: today})));
            }
            
            // 습도 조건
            if (weather.humidity >= 85) {
                notices.push(...mockNoticesDB.humid.map(n => ({...n, date: today})));
            }
            
            // 특별한 조건이 없으면 일반 날씨
            if (notices.length === 0) {
                notices.push(...mockNoticesDB.normal.map(n => ({...n, date: today})));
            }
            
            // 최대 3개까지, 우선순위 순 정렬
            return notices.slice(0, 3).sort((a, b) => a.priority - b.priority);
        }
        
        function displayResult(weather, location) {
            const resultDiv = document.getElementById('result');
            
            const priorityText = {
                1: '긴급',
                2: '주의',
                3: '정보'
            };
            
            let html = `
                <div class="weather-info">
                    <h3>📍 ${location} 현재 날씨</h3>
                    <p><strong>온도:</strong> ${weather.temperature}°C</p>
                    <p><strong>습도:</strong> ${weather.humidity}%</p>
                    <p><strong>강수량:</strong> ${weather.precipitation}mm</p>
                    <p><strong>풍속:</strong> ${weather.windSpeed}m/s</p>
                    <p><strong>날씨:</strong> ${weather.skyDescription}</p>
                    <p><strong>강수형태:</strong> ${weather.precipitationDescription}</p>
                </div>
                
                <h3>📋 생성된 공지사항</h3>
            `;
            
            if (weather.notices && weather.notices.length > 0) {
                weather.notices.forEach(notice => {
                    html += `
                        <div class="notice-card priority-${notice.priority}">
                            <div class="notice-title">
                                <span>${notice.icon}</span>
                                <span>${notice.title}</span>
                            </div>
                            <div class="notice-content">
                                ${notice.content}
                            </div>
                            <div class="notice-meta">
                                <span>카테고리: ${notice.category}</span>
                                <span class="priority-badge">${priorityText[notice.priority]}</span>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p>생성된 공지사항이 없습니다.</p>';
            }
            
            resultDiv.innerHTML = html;
        }
        
        // 페이지 로드 시 더미 데이터로 예시 보여주기
        window.onload = function() {
            testDummyWeather();
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Edge Functions í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .h {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section {
            background: white;
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section h2 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        textarea {
            height: 100px;
            resize: vertical;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px 10px 0;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .response-area {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .success {
            border-left: 4px solid #4CAF50;
            background-color: #f1f8e9;
        }
        
        .error {
            border-left: 4px solid #f44336;
            background-color: #ffebee;
        }
        
        .loading {
            color: #666;
            font-style: italic;
        }
        
        .tag-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .tag-input input {
            flex: 1;
        }
        
        .tags-display {
            margin-top: 5px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .tag {
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .sub-items-container {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: #fafafa;
        }
        
        .sub-item-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .sub-item-row input {
            flex: 1;
            margin: 0;
        }
        
        .sub-item-row button {
            margin: 0;
            padding: 8px 12px;
            font-size: 14px;
            background-color: #f44336;
        }
        
        .sub-item-row button:hover {
            background-color: #da190b;
        }
        
        .add-sub-item-btn {
            background-color: #2196F3 !important;
            margin-top: 10px;
        }
        
        .add-sub-item-btn:hover {
            background-color: #1976D2 !important;
        }
        
        .news-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .news-item:hover {
            border-color: #FF9800;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
        }
        
        .news-item.selected {
            border-color: #FF9800;
            background-color: #fff3e0;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
        }
        
        .news-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .news-description {
            color: #666;
            font-size: 12px;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .news-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #999;
        }
        
        .news-source {
            font-weight: bold;
        }
        
        .news-date {
            font-style: italic;
        }
        
        .news-selection-info {
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #1976D2;
        }
        
        .weather-info-card {
            background: white;
            border: 1px solid #2196F3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.1);
        }
        
        .weather-main {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .weather-icon {
            font-size: 48px;
            line-height: 1;
        }
        
        .weather-temp {
            font-size: 36px;
            font-weight: bold;
            color: #1976D2;
        }
        
        .weather-desc {
            font-size: 18px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .weather-location {
            font-size: 14px;
            color: #666;
        }
        
        .weather-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .weather-detail-item {
            background: #f5f5f5;
            padding: 8px 12px;
            border-radius: 5px;
            text-align: center;
            font-size: 12px;
        }
        
        .weather-detail-label {
            color: #666;
            margin-bottom: 3px;
        }
        
        .weather-detail-value {
            font-weight: bold;
            color: #333;
        }
        
        .weather-alert {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš€ Supabase Edge Functions í…ŒìŠ¤íŠ¸ ë„êµ¬</h1>
        <p>ê° ì—£ì§€ í•¨ìˆ˜ë“¤ì„ ì§ì ‘ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤</p>
    </div>

    <!-- AI Notice Generator í…ŒìŠ¤íŠ¸ -->
    <div class="test-section">
        <h2>ğŸ¤– AI Notice Generator - AI ë¬¸êµ¬ ìƒì„±</h2>
        
        <div class="form-group">
            <label for="ai-topic">ì£¼ì œ:</label>
            <input type="text" id="ai-topic" placeholder="ì˜ˆ: ê²¨ìš¸ì²  ê°ê¸° ì˜ˆë°©, êµì‹¤ ì •ë¦¬ì •ëˆ, ë…ì„œ ìŠµê´€">
        </div>
        
        <div class="form-group">
            <label for="ai-grade">í•™ë…„ (ì„ íƒì‚¬í•­):</label>
            <select id="ai-grade">
                <option value="">ì„ íƒ ì•ˆí•¨</option>
                <option value="ì´ˆë“± ì €í•™ë…„">ì´ˆë“± ì €í•™ë…„ (1-2í•™ë…„)</option>
                <option value="ì´ˆë“± ê³ í•™ë…„">ì´ˆë“± ê³ í•™ë…„ (3-6í•™ë…„)</option>
                <option value="ì¤‘í•™ìƒ">ì¤‘í•™ìƒ</option>
                <option value="ê³ ë“±í•™ìƒ">ê³ ë“±í•™ìƒ</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="ai-style">ë¬¸ì²´ ìŠ¤íƒ€ì¼:</label>
            <select id="ai-style">
                <option value="normal">ìì—°ìŠ¤ëŸ½ê²Œ</option>
                <option value="friendly">ì¹œê·¼í•˜ê³  ë”°ëœ»í•˜ê²Œ</option>
                <option value="formal">ì •ì¤‘í•˜ê³  ê²©ì‹ìˆê²Œ</option>
                <option value="simple">ì‰½ê³  ê°„ë‹¨í•˜ê²Œ</option>
            </select>
        </div>
        
        <button onclick="generateNotice()">ğŸ¤– AI ë¬¸êµ¬ ìƒì„±</button>
        <button onclick="clearAIForm()">ğŸ—‘ï¸ í¼ ì´ˆê¸°í™”</button>
        
        <div id="ai-response" class="response-area" style="display: none;"></div>
        
        <!-- ìƒì„±ëœ ë¬¸êµ¬ í¸ì§‘ ì˜ì—­ -->
        <div id="generated-notice-section" style="display: none; margin-top: 20px; padding: 20px; border: 2px solid #4CAF50; border-radius: 10px; background-color: #f8f9fa;">
            <h3>âœ¨ ìƒì„±ëœ ë¬¸êµ¬ (í¸ì§‘ ê°€ëŠ¥)</h3>
            
            <div class="form-group">
                <label for="generated-title">ì œëª©:</label>
                <input type="text" id="generated-title">
            </div>
            
            <div class="form-group">
                <label for="generated-content">ë©”ì¸ ë‚´ìš©:</label>
                <textarea id="generated-content" style="height: 80px;"></textarea>
            </div>
            
            <div class="form-group">
                <label for="generated-sub-items">ì„¸ë¶€ í•­ëª©:</label>
                <div id="generated-sub-items-container" class="sub-items-container">
                    <div class="sub-item-row">
                        <input type="text" placeholder="ì„¸ë¶€ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                        <button type="button" onclick="removeSubItem(this)">ì‚­ì œ</button>
                    </div>
                    <button type="button" class="add-sub-item-btn" onclick="addSubItem('generated-sub-items-container')">+ ì„¸ë¶€ í•­ëª© ì¶”ê°€</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="generated-tags">íƒœê·¸:</label>
                <div class="tag-input">
                    <input type="text" id="generated-tag-input" placeholder="íƒœê·¸ ì…ë ¥ í›„ Enter">
                    <button type="button" onclick="addGeneratedTag()">íƒœê·¸ ì¶”ê°€</button>
                </div>
                <div id="generated-tags-display" class="tags-display"></div>
            </div>
            
            <div class="form-group">
                <label for="generated-author">ì‘ì„±ì:</label>
                <input type="text" id="generated-author" placeholder="ì‘ì„±ì ID (ì„ íƒì‚¬í•­)" value="ai-generated">
            </div>
            
            <button onclick="saveGeneratedNotice()" style="background-color: #2196F3;">ğŸ’¾ ìˆ˜ì •ëœ ë¬¸êµ¬ ì €ì¥</button>
            <button onclick="hideGeneratedSection()">âŒ ì·¨ì†Œ</button>
            
            <div id="save-generated-response" class="response-area" style="display: none;"></div>
        </div>
    </div>

    <!-- Add Notice í…ŒìŠ¤íŠ¸ -->
    <div class="test-section">
        <h2>ğŸ“ Add Notice - ì•Œë¦¼ì¥ ë¬¸êµ¬ ì¶”ê°€</h2>
        
        <div class="form-group">
            <label for="notice-title">ì œëª©:</label>
            <input type="text" id="notice-title" placeholder="ì˜ˆ: ì—¬ë¦„ì²  ë¬¼ë†€ì´ ì•ˆì „ìˆ˜ì¹™">
        </div>
        
        <div class="form-group">
            <label for="notice-content">ë©”ì¸ ë‚´ìš©:</label>
            <textarea id="notice-content" placeholder="ë©”ì¸ ì•Œë¦¼ì¥ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="notice-sub-items">ì„¸ë¶€ í•­ëª©:</label>
            <div id="notice-sub-items-container" class="sub-items-container">
                <div class="sub-item-row">
                    <input type="text" placeholder="ì„¸ë¶€ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                    <button type="button" onclick="removeSubItem(this)">ì‚­ì œ</button>
                </div>
                <button type="button" class="add-sub-item-btn" onclick="addSubItem('notice-sub-items-container')">+ ì„¸ë¶€ í•­ëª© ì¶”ê°€</button>
            </div>
        </div>
        
        <div class="form-group">
            <label for="notice-tags">íƒœê·¸:</label>
            <div class="tag-input">
                <input type="text" id="notice-tag-input" placeholder="íƒœê·¸ ì…ë ¥ í›„ Enter">
                <button type="button" onclick="addTag()">íƒœê·¸ ì¶”ê°€</button>
            </div>
            <div id="notice-tags-display" class="tags-display"></div>
        </div>
        
        <div class="form-group">
            <label for="notice-author">ì‘ì„±ì:</label>
            <input type="text" id="notice-author" placeholder="ì‘ì„±ì ID (ì„ íƒì‚¬í•­)">
        </div>
        
        <button onclick="testAddNotice()">ğŸš€ Notice ì¶”ê°€ í…ŒìŠ¤íŠ¸</button>
        <button onclick="clearAddNoticeForm()">ğŸ—‘ï¸ í¼ ì´ˆê¸°í™”</button>
        
        <div id="add-notice-response" class="response-area" style="display: none;"></div>
    </div>

    <!-- í–¥í›„ í™•ì¥ì„ ìœ„í•œ í”Œë ˆì´ìŠ¤í™€ë” -->
    <div class="test-section">
        <h2>ğŸ“° News-based Notice Generator - ë‰´ìŠ¤ ê¸°ë°˜ ë¬¸êµ¬ ìƒì„±</h2>
        
        <div class="form-group">
            <label for="news-search-keyword">ë‰´ìŠ¤ ê²€ìƒ‰ í‚¤ì›Œë“œ:</label>
            <input type="text" id="news-search-keyword" placeholder="ì˜ˆ: êµìœ¡, ì•ˆì „, í™˜ê²½, ê±´ê°•">
        </div>
        
        <div class="form-group">
            <label for="news-display-count">ê²€ìƒ‰í•  ë‰´ìŠ¤ ê°œìˆ˜:</label>
            <select id="news-display-count">
                <option value="5">5ê°œ</option>
                <option value="10" selected>10ê°œ</option>
                <option value="20">20ê°œ</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="news-grade">ëŒ€ìƒ í•™ë…„ (ì„ íƒì‚¬í•­):</label>
            <select id="news-grade">
                <option value="">ì„ íƒ ì•ˆí•¨</option>
                <option value="ì´ˆë“± ì €í•™ë…„">ì´ˆë“± ì €í•™ë…„ (1-2í•™ë…„)</option>
                <option value="ì´ˆë“± ê³ í•™ë…„">ì´ˆë“± ê³ í•™ë…„ (3-6í•™ë…„)</option>
                <option value="ì¤‘í•™ìƒ">ì¤‘í•™ìƒ</option>
                <option value="ê³ ë“±í•™ìƒ">ê³ ë“±í•™ìƒ</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="news-style">ë¬¸ì²´ ìŠ¤íƒ€ì¼:</label>
            <select id="news-style">
                <option value="normal">ìì—°ìŠ¤ëŸ½ê²Œ</option>
                <option value="friendly">ì¹œê·¼í•˜ê³  ë”°ëœ»í•˜ê²Œ</option>
                <option value="formal">ì •ì¤‘í•˜ê³  ê²©ì‹ìˆê²Œ</option>
                <option value="simple">ì‰½ê³  ê°„ë‹¨í•˜ê²Œ</option>
            </select>
        </div>
        
        <button onclick="searchNews()">ğŸ“° ë‰´ìŠ¤ ê²€ìƒ‰</button>
        <button onclick="generateNewsBasedNotice()" id="generate-news-notice-btn" disabled>ğŸ¤– ë‰´ìŠ¤ ê¸°ë°˜ ë¬¸êµ¬ ìƒì„±</button>
        <button onclick="clearNewsForm()">ğŸ—‘ï¸ í¼ ì´ˆê¸°í™”</button>
        
        <div id="news-search-response" class="response-area" style="display: none;"></div>
        
        <!-- ê²€ìƒ‰ëœ ë‰´ìŠ¤ ëª©ë¡ -->
        <div id="news-list-section" style="display: none; margin-top: 20px; padding: 20px; border: 2px solid #FF9800; border-radius: 10px; background-color: #fff3e0;">
            <h3>ğŸ“„ ê²€ìƒ‰ëœ ë‰´ìŠ¤ (ì„ íƒí•´ì£¼ì„¸ìš”)</h3>
            <div id="news-items-container"></div>
        </div>
        
        <!-- ë‰´ìŠ¤ ê¸°ë°˜ ìƒì„±ëœ ë¬¸êµ¬ í¸ì§‘ ì˜ì—­ -->
        <div id="news-generated-notice-section" style="display: none; margin-top: 20px; padding: 20px; border: 2px solid #4CAF50; border-radius: 10px; background-color: #f8f9fa;">
            <h3>âœ¨ ë‰´ìŠ¤ ê¸°ë°˜ ìƒì„±ëœ ë¬¸êµ¬ (í¸ì§‘ ê°€ëŠ¥)</h3>
            
            <div class="form-group">
                <label for="news-generated-title">ì œëª©:</label>
                <input type="text" id="news-generated-title">
            </div>
            
            <div class="form-group">
                <label for="news-generated-content">ë©”ì¸ ë‚´ìš©:</label>
                <textarea id="news-generated-content" style="height: 80px;"></textarea>
            </div>
            
            <div class="form-group">
                <label for="news-generated-sub-items">ì„¸ë¶€ í•­ëª©:</label>
                <div id="news-generated-sub-items-container" class="sub-items-container">
                    <div class="sub-item-row">
                        <input type="text" placeholder="ì„¸ë¶€ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                        <button type="button" onclick="removeSubItem(this)">ì‚­ì œ</button>
                    </div>
                    <button type="button" class="add-sub-item-btn" onclick="addSubItem('news-generated-sub-items-container')">+ ì„¸ë¶€ í•­ëª© ì¶”ê°€</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="news-generated-tags">íƒœê·¸:</label>
                <div class="tag-input">
                    <input type="text" id="news-generated-tag-input" placeholder="íƒœê·¸ ì…ë ¥ í›„ Enter">
                    <button type="button" onclick="addNewsGeneratedTag()">íƒœê·¸ ì¶”ê°€</button>
                </div>
                <div id="news-generated-tags-display" class="tags-display"></div>
            </div>
            
            <div class="form-group">
                <label for="news-generated-author">ì‘ì„±ì:</label>
                <input type="text" id="news-generated-author" placeholder="ì‘ì„±ì ID (ì„ íƒì‚¬í•­)" value="news-ai-generated">
            </div>
            
            <div class="form-group">
                <label>ì°¸ì¡°í•œ ë‰´ìŠ¤:</label>
                <div id="news-source-info" style="font-size: 12px; color: #666; padding: 10px; background: #f0f0f0; border-radius: 5px;"></div>
            </div>
            
            <button onclick="saveNewsGeneratedNotice()" style="background-color: #2196F3;">ğŸ’¾ ë‰´ìŠ¤ ê¸°ë°˜ ë¬¸êµ¬ ì €ì¥</button>
            <button onclick="hideNewsGeneratedSection()">âŒ ì·¨ì†Œ</button>
            
            <div id="save-news-generated-response" class="response-area" style="display: none;"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸŒ¤ï¸ Weather-based Notice Generator - ë‚ ì”¨ ê¸°ë°˜ ë¬¸êµ¬ ìƒì„±</h2>
        
        <div class="form-group">
            <label for="weather-location">ì§€ì—­ ì„ íƒ:</label>
            <select id="weather-location">
                <option value="">ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ì„œìš¸">ì„œìš¸</option>
                <option value="ì¸ì²œ">ì¸ì²œ</option>
                <option value="ê²½ê¸°">ê²½ê¸°</option>
                <option value="ê°•ì›">ê°•ì›</option>
                <option value="ì¶©ë¶">ì¶©ë¶</option>
                <option value="ì¶©ë‚¨">ì¶©ë‚¨</option>
                <option value="ëŒ€ì „">ëŒ€ì „</option>
                <option value="ì„¸ì¢…">ì„¸ì¢…</option>
                <option value="ì „ë¶">ì „ë¶</option>
                <option value="ì „ë‚¨">ì „ë‚¨</option>
                <option value="ê´‘ì£¼">ê´‘ì£¼</option>
                <option value="ê²½ë¶">ê²½ë¶</option>
                <option value="ê²½ë‚¨">ê²½ë‚¨</option>
                <option value="ëŒ€êµ¬">ëŒ€êµ¬</option>
                <option value="ìš¸ì‚°">ìš¸ì‚°</option>
                <option value="ë¶€ì‚°">ë¶€ì‚°</option>
                <option value="ì œì£¼">ì œì£¼</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="weather-detail-location">ìƒì„¸ ì§€ì—­ (ì„ íƒì‚¬í•­):</label>
            <input type="text" id="weather-detail-location" placeholder="ì˜ˆ: ê°•ë‚¨êµ¬, í•´ìš´ëŒ€êµ¬, ì¤‘êµ¬">
        </div>
        
        <div class="form-group">
            <label for="weather-grade">ëŒ€ìƒ í•™ë…„ (ì„ íƒì‚¬í•­):</label>
            <select id="weather-grade">
                <option value="">ì„ íƒ ì•ˆí•¨</option>
                <option value="ì´ˆë“± ì €í•™ë…„">ì´ˆë“± ì €í•™ë…„ (1-2í•™ë…„)</option>
                <option value="ì´ˆë“± ê³ í•™ë…„">ì´ˆë“± ê³ í•™ë…„ (3-6í•™ë…„)</option>
                <option value="ì¤‘í•™ìƒ">ì¤‘í•™ìƒ</option>
                <option value="ê³ ë“±í•™ìƒ">ê³ ë“±í•™ìƒ</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="weather-style">ë¬¸ì²´ ìŠ¤íƒ€ì¼:</label>
            <select id="weather-style">
                <option value="normal">ìì—°ìŠ¤ëŸ½ê²Œ</option>
                <option value="friendly">ì¹œê·¼í•˜ê³  ë”°ëœ»í•˜ê²Œ</option>
                <option value="formal">ì •ì¤‘í•˜ê³  ê²©ì‹ìˆê²Œ</option>
                <option value="simple">ì‰½ê³  ê°„ë‹¨í•˜ê²Œ</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="weather-focus">ì´ˆì  ì˜ì—­:</label>
            <select id="weather-focus">
                <option value="safety">ì•ˆì „ (ìš°ì‚°, ë¯¸ë„ëŸ¼ ì£¼ì˜ ë“±)</option>
                <option value="health">ê±´ê°• (ì˜·ì°¨ë¦¼, ìˆ˜ë¶„ì„­ì·¨ ë“±)</option>
                <option value="activity">í™œë™ (ì‹¤ë‚´ì™¸ í™œë™ ì¡°ì •)</option>
                <option value="general">ì¢…í•© (ì „ë°˜ì ì¸ ë‚ ì”¨ ëŒ€ì‘)</option>
            </select>
        </div>
        
        <button onclick="getWeatherInfo()">ğŸŒ¤ï¸ ë‚ ì”¨ ì •ë³´ ì¡°íšŒ</button>
        <button onclick="generateWeatherBasedNotice()" id="generate-weather-notice-btn" disabled>ğŸ¤– ë‚ ì”¨ ê¸°ë°˜ ë¬¸êµ¬ ìƒì„±</button>
        <button onclick="clearWeatherForm()">ğŸ—‘ï¸ í¼ ì´ˆê¸°í™”</button>
        
        <div id="weather-info-response" class="response-area" style="display: none;"></div>
        
        <!-- ë‚ ì”¨ ì •ë³´ í‘œì‹œ -->
        <div id="weather-info-section" style="display: none; margin-top: 20px; padding: 20px; border: 2px solid #2196F3; border-radius: 10px; background-color: #e3f2fd;">
            <h3>ğŸŒ¡ï¸ í˜„ì¬ ë‚ ì”¨ ì •ë³´</h3>
            <div id="weather-display-container"></div>
        </div>
        
        <!-- ë‚ ì”¨ ê¸°ë°˜ ìƒì„±ëœ ë¬¸êµ¬ í¸ì§‘ ì˜ì—­ -->
        <div id="weather-generated-notice-section" style="display: none; margin-top: 20px; padding: 20px; border: 2px solid #4CAF50; border-radius: 10px; background-color: #f8f9fa;">
            <h3>âœ¨ ë‚ ì”¨ ê¸°ë°˜ ìƒì„±ëœ ë¬¸êµ¬ (í¸ì§‘ ê°€ëŠ¥)</h3>
            
            <div class="form-group">
                <label for="weather-generated-title">ì œëª©:</label>
                <input type="text" id="weather-generated-title">
            </div>
            
            <div class="form-group">
                <label for="weather-generated-content">ë©”ì¸ ë‚´ìš©:</label>
                <textarea id="weather-generated-content" style="height: 80px;"></textarea>
            </div>
            
            <div class="form-group">
                <label for="weather-generated-sub-items">ì„¸ë¶€ í•­ëª©:</label>
                <div id="weather-generated-sub-items-container" class="sub-items-container">
                    <div class="sub-item-row">
                        <input type="text" placeholder="ì„¸ë¶€ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                        <button type="button" onclick="removeSubItem(this)">ì‚­ì œ</button>
                    </div>
                    <button type="button" class="add-sub-item-btn" onclick="addSubItem('weather-generated-sub-items-container')">+ ì„¸ë¶€ í•­ëª© ì¶”ê°€</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="weather-generated-tags">íƒœê·¸:</label>
                <div class="tag-input">
                    <input type="text" id="weather-generated-tag-input" placeholder="íƒœê·¸ ì…ë ¥ í›„ Enter">
                    <button type="button" onclick="addWeatherGeneratedTag()">íƒœê·¸ ì¶”ê°€</button>
                </div>
                <div id="weather-generated-tags-display" class="tags-display"></div>
            </div>
            
            <div class="form-group">
                <label for="weather-generated-author">ì‘ì„±ì:</label>
                <input type="text" id="weather-generated-author" placeholder="ì‘ì„±ì ID (ì„ íƒì‚¬í•­)" value="weather-ai-generated">
            </div>
            
            <div class="form-group">
                <label>ì°¸ì¡°í•œ ë‚ ì”¨ ì •ë³´:</label>
                <div id="weather-source-info" style="font-size: 12px; color: #666; padding: 10px; background: #f0f0f0; border-radius: 5px;"></div>
            </div>
            
            <button onclick="saveWeatherGeneratedNotice()" style="background-color: #2196F3;">ï¿½ ë‚ ì”¨ ê¸°ë°˜ ë¬¸êµ¬ ì €ì¥</button>
            <button onclick="hideWeatherGeneratedSection()">âŒ ì·¨ì†Œ</button>
            
            <div id="save-weather-generated-response" class="response-area" style="display: none;"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ« School Search + Weather Notice Generator - í•™êµë³„ ë‚ ì”¨ ê¸°ë°˜ ë¬¸êµ¬ ìƒì„±</h2>
        
        <!-- ë‹¨ê³„ë³„ ì§„í–‰ í‘œì‹œ -->
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <div class="workflow-step" id="school-step-1" style="flex: 1; text-align: center; padding: 10px; border-radius: 5px; background: #e3f2fd; margin: 0 5px;">
                <div style="font-weight: bold; color: #1976d2;">1ë‹¨ê³„</div>
                <div style="font-size: 12px;">í•™êµ ê²€ìƒ‰</div>
            </div>
            <div class="workflow-step" id="school-step-2" style="flex: 1; text-align: center; padding: 10px; border-radius: 5px; background: #f5f5f5; margin: 0 5px;">
                <div style="font-weight: bold; color: #666;">2ë‹¨ê³„</div>
                <div style="font-size: 12px;">ìœ„ì¹˜ ë³€í™˜</div>
            </div>
            <div class="workflow-step" id="school-step-3" style="flex: 1; text-align: center; padding: 10px; border-radius: 5px; background: #f5f5f5; margin: 0 5px;">
                <div style="font-weight: bold; color: #666;">3ë‹¨ê³„</div>
                <div style="font-size: 12px;">ë‚ ì”¨ ì¡°íšŒ</div>
            </div>
            <div class="workflow-step" id="school-step-4" style="flex: 1; text-align: center; padding: 10px; border-radius: 5px; background: #f5f5f5; margin: 0 5px;">
                <div style="font-weight: bold; color: #666;">4ë‹¨ê³„</div>
                <div style="font-size: 12px;">ë¬¸êµ¬ ìƒì„±</div>
            </div>
        </div>
        
        <!-- 1ë‹¨ê³„: í•™êµ ê²€ìƒ‰ -->
        <div class="form-group">
            <label for="school-search-input">í•™êµëª… ê²€ìƒ‰ (ìë™ì™„ì„±):</label>
            <div style="position: relative;">
                <input type="text" id="school-search-input" placeholder="í•™êµëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì„œìš¸ì´ˆë“±í•™êµ)" autocomplete="off">
                <div id="school-suggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 5px 5px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;">
                </div>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">2ê¸€ì ì´ìƒ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ê²€ìƒ‰ë©ë‹ˆë‹¤.</div>
        </div>
        
        <!-- ì„ íƒëœ í•™êµ ì •ë³´ í‘œì‹œ -->
        <div id="selected-school-display" style="display: none; background: #e8f5e8; border: 1px solid #4caf50; border-radius: 5px; padding: 15px; margin-bottom: 15px;">
            <h4 style="color: #2e7d32; margin: 0 0 10px 0;">âœ… ì„ íƒëœ í•™êµ</h4>
            <div id="selected-school-details"></div>
        </div>
        
        <!-- 2ë‹¨ê³„: ìœ„ì¹˜ ì •ë³´ í‘œì‹œ -->
        <div id="location-info-display" style="display: none; background: #e3f2fd; border: 1px solid #2196f3; border-radius: 5px; padding: 15px; margin-bottom: 15px;">
            <h4 style="color: #1976d2; margin: 0 0 10px 0;">ğŸ“ ìœ„ì¹˜ ì •ë³´</h4>
            <div id="location-details"></div>
        </div>
        
        <!-- 3ë‹¨ê³„: ë‚ ì”¨ ì •ë³´ í‘œì‹œ -->
        <div id="school-weather-info-display" style="display: none; background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); border-radius: 8px; padding: 20px; margin-bottom: 15px; color: white;">
            <h4 style="color: white; margin: 0 0 15px 0;">ğŸŒ¤ï¸ í˜„ì¬ ë‚ ì”¨</h4>
            <div id="school-weather-details"></div>
        </div>
        
        <!-- 4ë‹¨ê³„: ìƒì„±ëœ ê³µì§€ì‚¬í•­ í‘œì‹œ -->
        <div id="school-notices-display" style="display: none; margin-bottom: 15px;">
            <h4 style="color: #333; margin: 0 0 15px 0;">ğŸ“‹ ë‚ ì”¨ ê¸°ë°˜ ìƒì„±ëœ ê³µì§€ì‚¬í•­</h4>
            <div id="school-notices-container"></div>
        </div>
        
        <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ -->
        <div style="margin-top: 20px;">
            <button onclick="runSchoolWeatherWorkflow()" id="run-school-workflow-btn" disabled>ğŸš€ ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰</button>
            <button onclick="clearSchoolWorkflow()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
        </div>
        
        <div id="school-workflow-response" class="response-area" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ« School Search (ë…ë¦½ í…ŒìŠ¤íŠ¸)</h2>
    <div class="test-section">
        <h2>ğŸ« School Search (ë…ë¦½ í…ŒìŠ¤íŠ¸)</h2>
        
        <div class="form-group">
            <label for="school-name-search">í•™êµëª…:</label>
            <input type="text" id="school-name-search" placeholder="ê²€ìƒ‰í•  í•™êµëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        
        <div class="form-group">
            <label for="school-search-limit">ê²€ìƒ‰ ê²°ê³¼ ìˆ˜:</label>
            <select id="school-search-limit">
                <option value="5">5ê°œ</option>
                <option value="10" selected>10ê°œ</option>
                <option value="20">20ê°œ</option>
                <option value="50">50ê°œ</option>
            </select>
        </div>
        
        <button onclick="testSchoolSearch()">ğŸ” í•™êµ ê²€ìƒ‰ í…ŒìŠ¤íŠ¸</button>
        <button onclick="clearSchoolSearchForm()">ï¿½ï¸ í¼ ì´ˆê¸°í™”</button>
        
        <div id="school-search-response" class="response-area" style="display: none;"></div>
    </div>
    </div>

    <script>
        // ì„¤ì •
        const SUPABASE_URL = 'https://unjxokjoytbwkqmqidni.supabase.co'; // ë¡œì»¬ ê°œë°œìš©
        const currentTags = [];

        // === ë‚ ì”¨ ê¸°ë°˜ ê³µì§€ì‚¬í•­ ìƒì„± í•¨ìˆ˜ ===
        function generateWeatherNoticesFromData(weatherData) {
            const notices = [];
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            
            // ì˜¨ë„ ê¸°ë°˜ ê³µì§€ì‚¬í•­
            if (weatherData.temperature >= 33) {
                notices.push({
                    title: "í­ì—¼ íŠ¹ë³´ - í•™ìƒ ì•ˆì „ ê´€ë¦¬ ê°•í™”",
                    content: `ê¸°ì˜¨ì´ ${weatherData.temperature}Â°Cë¡œ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤. êµì‹¤ ì—ì–´ì»¨ì„ ê°€ë™í•˜ê³  í•™ìƒë“¤ì˜ ì¶©ë¶„í•œ ìˆ˜ë¶„ ì„­ì·¨ë¥¼ ë…ë ¤í•´ ì£¼ì„¸ìš”. ì•¼ì™¸í™œë™ì€ ê¸ˆì§€í•˜ê³  ì‹¤ë‚´ì—ì„œë§Œ í™œë™í•˜ë„ë¡ ì§€ë„ë°”ëë‹ˆë‹¤.`,
                    date: dateString,
                    category: "ì•ˆì „",
                    priority: 1,
                    icon: "ğŸŒ¡ï¸"
                });
            } else if (weatherData.temperature >= 28) {
                notices.push({
                    title: "ë¬´ë”ìœ„ ì£¼ì˜ - êµì‹¤ í™˜ê¸° ë° ì˜¨ë„ ê´€ë¦¬",
                    content: `ê¸°ì˜¨ì´ ${weatherData.temperature}Â°Cë¡œ ë†’ìŠµë‹ˆë‹¤. ì •ê¸°ì ì¸ í™˜ê¸°ë¥¼ ì‹¤ì‹œí•˜ê³  í•™ìƒë“¤ì´ ë”ìœ„ë¥¼ ëŠë¼ì§€ ì•Šë„ë¡ êµì‹¤ ì˜¨ë„ë¥¼ ì ì ˆíˆ ì¡°ì ˆí•´ ì£¼ì„¸ìš”.`,
                    date: dateString,
                    category: "ê±´ê°•",
                    priority: 2,
                    icon: "â˜€ï¸"
                });
            } else if (weatherData.temperature <= 0) {
                notices.push({
                    title: "í˜¹í•œê¸° íŠ¹ë³´ - ë™ìƒ ë° ì €ì²´ì˜¨ì¦ ì£¼ì˜",
                    content: `ê¸°ì˜¨ì´ ${weatherData.temperature}Â°Cë¡œ ë§¤ìš° ë‚®ìŠµë‹ˆë‹¤. í•™ìƒë“¤ì˜ ë°©í•œë³µ ì°©ìš©ì„ í™•ì¸í•˜ê³  ì†ë°œ ì‹œë¦¼ì´ë‚˜ ë–¨ë¦¼ ì¦ìƒì„ ë³´ì´ëŠ” í•™ìƒì€ ì¦‰ì‹œ ë”°ëœ»í•œ ê³³ìœ¼ë¡œ ì´ë™ì‹œì¼œ ì£¼ì„¸ìš”.`,
                    date: dateString,
                    category: "ì•ˆì „",
                    priority: 1,
                    icon: "ğŸ¥¶"
                });
            } else if (weatherData.temperature <= 5) {
                notices.push({
                    title: "í•œíŒŒ ì£¼ì˜ - ë°©í•œìš©í’ˆ ì°©ìš© ì§€ë„",
                    content: `ê¸°ì˜¨ì´ ${weatherData.temperature}Â°Cë¡œ ì¶¥ìŠµë‹ˆë‹¤. í•™ìƒë“¤ì´ ì¶©ë¶„í•œ ë°©í•œë³µì„ ì°©ìš©í–ˆëŠ”ì§€ í™•ì¸í•˜ê³ , êµì‹¤ ë‚œë°©ì„ ì ì ˆíˆ ì¡°ì ˆí•´ ì£¼ì„¸ìš”.`,
                    date: dateString,
                    category: "ê±´ê°•",
                    priority: 2,
                    icon: "â„ï¸"
                });
            }
            
            // ê°•ìˆ˜ëŸ‰ ê¸°ë°˜ ê³µì§€ì‚¬í•­
            if (weatherData.precipitation >= 20) {
                notices.push({
                    title: "í­ìš° ê²½ë³´ - ë“±í•˜êµ ì•ˆì „ ê´€ë¦¬",
                    content: `ì‹œê°„ë‹¹ ${weatherData.precipitation}mmì˜ í­ìš°ê°€ ë‚´ë¦¬ê³  ìˆìŠµë‹ˆë‹¤. í•™ìƒë“¤ì˜ ì•ˆì „í•œ ë“±í•˜êµë¥¼ ìœ„í•´ ìš°ì‚° ì§€ì°¸ì„ í™•ì¸í•˜ê³ , ì¹¨ìˆ˜ ìœ„í—˜ ì§€ì—­ ìš°íšŒë¥¼ ì•ˆë‚´í•´ ì£¼ì„¸ìš”.`,
                    date: dateString,
                    category: "ì•ˆì „",
                    priority: 1,
                    icon: "ğŸŒŠ"
                });
            } else if (weatherData.precipitation > 0) {
                if (weatherData.precipitationDescription === 'ëˆˆ' || weatherData.precipitationDescription.includes('ëˆˆ')) {
                    notices.push({
                        title: "ì ì„¤ ì£¼ì˜ - ë¹™íŒê¸¸ ì•ˆì „ì‚¬ê³  ì˜ˆë°©",
                        content: `ëˆˆì´ ë‚´ë ¤ êµë‚´ì— ë¹™íŒê¸¸ì´ í˜•ì„±ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•™ìƒë“¤ì—ê²Œ ì²œì²œíˆ ê±·ê¸°ë¥¼ ì§€ë„í•˜ê³ , ê³„ë‹¨ì´ë‚˜ ê²½ì‚¬ë¡œì—ì„œëŠ” íŠ¹íˆ ì£¼ì˜í•˜ë„ë¡ ì•ˆë‚´í•´ ì£¼ì„¸ìš”.`,
                        date: dateString,
                        category: "ì•ˆì „",
                        priority: 1,
                        icon: "â›„"
                    });
                } else {
                    notices.push({
                        title: "ìš°ì²œ ì‹œ ì•ˆì „ ê·€ê°€ ì§€ë„",
                        content: "ë¹„ê°€ ë‚´ë¦¬ê³  ìˆìŠµë‹ˆë‹¤. í•™ìƒë“¤ì´ ìš°ì‚°ì„ ì¤€ë¹„í–ˆëŠ”ì§€ í™•ì¸í•˜ê³ , ë¯¸ë„ëŸ¬ìš´ ê¸¸ë©´ì—ì„œì˜ ì•ˆì „ì‚¬ê³  ì˜ˆë°©ì„ ìœ„í•œ ì£¼ì˜ì‚¬í•­ì„ ë‹¹ë¶€í•´ ì£¼ì„¸ìš”.",
                        date: dateString,
                        category: "ì•ˆì „",
                        priority: 2,
                        icon: "â˜”"
                    });
                }
            }
            
            // í’ì† ê¸°ë°˜ ê³µì§€ì‚¬í•­
            if (weatherData.windSpeed >= 14) {
                notices.push({
                    title: "ê°•í’ ê²½ë³´ - ì•¼ì™¸í™œë™ ì „ë©´ ê¸ˆì§€",
                    content: `í’ì† ${weatherData.windSpeed}m/sì˜ ê°•í’ì´ ë¶ˆê³  ìˆìŠµë‹ˆë‹¤. ëª¨ë“  ì•¼ì™¸í™œë™ì„ ì¤‘ë‹¨í•˜ê³  ì‹¤ë‚´ë¡œ ëŒ€í”¼ì‹œì¼œ ì£¼ì„¸ìš”. ì°½ë¬¸ ì ê²€ì„ ì‹¤ì‹œí•˜ì—¬ íŒŒì† ìœ„í—˜ì„ ì°¨ë‹¨í•´ ì£¼ì„¸ìš”.`,
                    date: dateString,
                    category: "ì•ˆì „",
                    priority: 1,
                    icon: "ğŸ’¨"
                });
            } else if (weatherData.windSpeed >= 10) {
                notices.push({
                    title: "ê°•í’ ì£¼ì˜ - ì•¼ì™¸í™œë™ ì œí•œ",
                    content: `í’ì† ${weatherData.windSpeed}m/sì˜ ë°”ëŒì´ ë¶ˆê³  ìˆìŠµë‹ˆë‹¤. ì•¼ì™¸í™œë™ ì‹œ ì£¼ì˜ë¥¼ ê¸°ìš¸ì´ê³ , ë‚ ì•„ê°ˆ ìˆ˜ ìˆëŠ” ë¬¼ê±´ë“¤ì„ ì•ˆì „í•œ ê³³ì— ë³´ê´€í•´ ì£¼ì„¸ìš”.`,
                    date: dateString,
                    category: "ì•ˆì „",
                    priority: 2,
                    icon: "ğŸŒ¬ï¸"
                });
            }
            
            // ìŠµë„ ê¸°ë°˜ ê³µì§€ì‚¬í•­
            if (weatherData.humidity >= 85) {
                notices.push({
                    title: "ê³ ìŠµë„ ì£¼ì˜ - êµì‹¤ ì œìŠµ ë° í™˜ê¸°",
                    content: `ìŠµë„ê°€ ${weatherData.humidity}%ë¡œ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤. ì œìŠµê¸°ë¥¼ ê°€ë™í•˜ê³  ìì£¼ í™˜ê¸°ë¥¼ ì‹¤ì‹œí•´ ì£¼ì„¸ìš”. ê³°íŒ¡ì´ ë° ì„¸ê·  ë²ˆì‹ì„ ì˜ˆë°©í•˜ê¸° ìœ„í•´ êµì‹¤ êµ¬ì„êµ¬ì„ ì ê²€í•´ ì£¼ì„¸ìš”.`,
                    date: dateString,
                    category: "ê±´ê°•",
                    priority: 2,
                    icon: "ğŸ’§"
                });
            }
            
            // íŠ¹ë³„í•œ ì¡°ê±´ì´ ì—†ìœ¼ë©´ ì¼ë°˜ ë‚ ì”¨ ê³µì§€ì‚¬í•­
            if (notices.length === 0) {
                notices.push({
                    title: "ì¾Œì í•œ ë‚ ì”¨ - ì•¼ì™¸ êµìœ¡í™œë™ ì¶”ì²œ",
                    content: `ê¸°ì˜¨ ${weatherData.temperature}Â°Cì˜ ì¾Œì í•œ ë‚ ì”¨ì…ë‹ˆë‹¤. ìì—° ê´€ì°°, ìš´ë™ì¥ ì²´ìœ¡í™œë™ ë“±ì„ í†µí•´ í•™ìƒë“¤ì´ ìì—°ê³¼ í•¨ê»˜í•  ìˆ˜ ìˆëŠ” ì‹œê°„ì„ ê°€ì ¸ë³´ì‹œê¸° ë°”ëë‹ˆë‹¤.`,
                    date: dateString,
                    category: "í•™êµí™œë™",
                    priority: 3,
                    icon: "ğŸŒ¤ï¸"
                });
            }
            
            // ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ì •ë ¬í•˜ê³  ìµœëŒ€ 3ê°œê¹Œì§€ë§Œ ë°˜í™˜
            return notices.sort((a, b) => a.priority - b.priority).slice(0, 3);
        }

        // === ì„¸ë¶€ í•­ëª© ê´€ë¦¬ í•¨ìˆ˜ë“¤ ===
        function addSubItem(containerId) {
            const container = document.getElementById(containerId);
            const addButton = container.querySelector('.add-sub-item-btn');
            
            const newRow = document.createElement('div');
            newRow.className = 'sub-item-row';
            newRow.innerHTML = `
                <input type="text" placeholder="ì„¸ë¶€ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                <button type="button" onclick="removeSubItem(this)">ì‚­ì œ</button>
            `;
            
            // ì¶”ê°€ ë²„íŠ¼ ì•ì— ìƒˆ í–‰ ì¶”ê°€
            container.insertBefore(newRow, addButton);
        }

        function removeSubItem(button) {
            const row = button.parentElement;
            const container = row.parentElement;
            
            // ìµœì†Œ 1ê°œëŠ” ìœ ì§€
            const remainingRows = container.querySelectorAll('.sub-item-row').length;
            if (remainingRows > 1) {
                row.remove();
            } else {
                // ë§ˆì§€ë§‰ í•­ëª©ì´ë©´ ë‚´ìš©ë§Œ ë¹„ìš°ê¸°
                const input = row.querySelector('input');
                input.value = '';
            }
        }

        function getSubItemsFromContainer(containerId) {
            const container = document.getElementById(containerId);
            const inputs = container.querySelectorAll('.sub-item-row input');
            const subItems = [];
            
            inputs.forEach(input => {
                const value = input.value.trim();
                if (value) {
                    subItems.push(value);
                }
            });
            
            return subItems;
        }

        function setSubItemsToContainer(containerId, subItems) {
            const container = document.getElementById(containerId);
            
            // ê¸°ì¡´ í•­ëª©ë“¤ ëª¨ë‘ ì œê±° (ì¶”ê°€ ë²„íŠ¼ ì œì™¸)
            const existingRows = container.querySelectorAll('.sub-item-row');
            existingRows.forEach(row => row.remove());
            
            // ìƒˆ í•­ëª©ë“¤ ì¶”ê°€
            const addButton = container.querySelector('.add-sub-item-btn');
            
            if (subItems.length === 0) {
                // ë¹ˆ í•­ëª© í•˜ë‚˜ ì¶”ê°€
                const newRow = document.createElement('div');
                newRow.className = 'sub-item-row';
                newRow.innerHTML = `
                    <input type="text" placeholder="ì„¸ë¶€ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                    <button type="button" onclick="removeSubItem(this)">ì‚­ì œ</button>
                `;
                container.insertBefore(newRow, addButton);
            } else {
                subItems.forEach(item => {
                    const newRow = document.createElement('div');
                    newRow.className = 'sub-item-row';
                    newRow.innerHTML = `
                        <input type="text" value="${item.replace(/"/g, '&quot;')}" placeholder="ì„¸ë¶€ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                        <button type="button" onclick="removeSubItem(this)">ì‚­ì œ</button>
                    `;
                    container.insertBefore(newRow, addButton);
                });
            }
        }

        // íƒœê·¸ ê´€ë¦¬
        function addTag() {
            const input = document.getElementById('notice-tag-input');
            const tag = input.value.trim();
            
            if (tag && !currentTags.includes(tag)) {
                currentTags.push(tag);
                updateTagsDisplay();
                input.value = '';
            }
        }

        function removeTag(tagToRemove) {
            const index = currentTags.indexOf(tagToRemove);
            if (index > -1) {
                currentTags.splice(index, 1);
                updateTagsDisplay();
            }
        }

        function updateTagsDisplay() {
            const display = document.getElementById('notice-tags-display');
            display.innerHTML = currentTags.map(tag => 
                `<span class="tag" onclick="removeTag('${tag}')">${tag} Ã—</span>`
            ).join('');
        }

        // Enter í‚¤ë¡œ íƒœê·¸ ì¶”ê°€
        document.getElementById('notice-tag-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTag();
            }
        });

        // Add Notice í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        async function testAddNotice() {
            const title = document.getElementById('notice-title').value;
            const content = document.getElementById('notice-content').value;
            const subItems = getSubItemsFromContainer('notice-sub-items-container');
            const author = document.getElementById('notice-author').value;
            const responseArea = document.getElementById('add-notice-response');
            
            // ì…ë ¥ ê²€ì¦
            if (!title || (!content && subItems.length === 0)) {
                showResponse(responseArea, 'ì œëª©ê³¼ ë©”ì¸ ë‚´ìš©(ë˜ëŠ” ì„¸ë¶€ í•­ëª©)ì€ í•„ìˆ˜ì…ë‹ˆë‹¤!', 'error');
                return;
            }

            // ë¡œë”© í‘œì‹œ
            showResponse(responseArea, 'ìš”ì²­ ì¤‘...', 'loading');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/add-notice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        subItems: subItems,
                        tags: currentTags,
                        author: author || 'test-user'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResponse(responseArea, `âœ… ì„±ê³µ!\n\n${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    showResponse(responseArea, `âŒ ì˜¤ë¥˜!\n\n${JSON.stringify(result, null, 2)}`, 'error');
                }
                
            } catch (error) {
                showResponse(responseArea, `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜!\n\n${error.message}`, 'error');
            }
        }

        // í¼ ì´ˆê¸°í™”
        function clearAddNoticeForm() {
            document.getElementById('notice-title').value = '';
            document.getElementById('notice-content').value = '';
            setSubItemsToContainer('notice-sub-items-container', []);
            document.getElementById('notice-author').value = '';
            currentTags.length = 0;
            updateTagsDisplay();
            
            const responseArea = document.getElementById('add-notice-response');
            responseArea.style.display = 'none';
        }

        // ì‘ë‹µ í‘œì‹œ í•¨ìˆ˜
        function showResponse(element, message, type) {
            const timestamp = new Date().toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            const messageWithTimestamp = `[${timestamp}] ${message}`;
            element.textContent = messageWithTimestamp;
            element.style.display = 'block';
            element.className = `response-area ${type}`;
        }

        // ìƒ˜í”Œ ë°ì´í„° ìë™ ì…ë ¥ (ê°œë°œ í¸ì˜ìš©)
        function loadSampleData() {
            document.getElementById('notice-title').value = 'ì—¬ë¦„ì²  ë¬¼ë†€ì´ ì•ˆì „ìˆ˜ì¹™';
            document.getElementById('notice-content').value = 'ë¬´ë”ìš´ ì—¬ë¦„, ë¬¼ë†€ì´ ì•ˆì „ì— ê°ë³„íˆ ì£¼ì˜í•´ì£¼ì„¸ìš”.';
            setSubItemsToContainer('notice-sub-items-container', [
                'ê¹Šì€ ë¬¼ì—ëŠ” ì ˆëŒ€ ë“¤ì–´ê°€ì§€ ë§ˆì„¸ìš”',
                'í˜¼ìì„œ ë¬¼ë†€ì´ í•˜ì§€ ë§ˆì„¸ìš”',
                'ë¬¼ì— ë“¤ì–´ê°€ê¸° ì „ ì¤€ë¹„ìš´ë™ì„ ê¼­ í•˜ì„¸ìš”'
            ]);
            currentTags.push('ì•ˆì „', 'ì—¬ë¦„í™œë™', 'ë¬¼ë†€ì´');
            updateTagsDisplay();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ (ê°œë°œ í¸ì˜ìš©)
        window.addEventListener('load', () => {
            loadSampleData();
        });

        // === AI ë¬¸êµ¬ ìƒì„± ê´€ë ¨ í•¨ìˆ˜ë“¤ ===
        const generatedTags = []; // AI ìƒì„± ë¬¸êµ¬ìš© íƒœê·¸
        const newsGeneratedTags = []; // ë‰´ìŠ¤ ê¸°ë°˜ AI ìƒì„± ë¬¸êµ¬ìš© íƒœê·¸
        const weatherGeneratedTags = []; // ë‚ ì”¨ ê¸°ë°˜ AI ìƒì„± ë¬¸êµ¬ìš© íƒœê·¸
        let selectedNewsItems = []; // ì„ íƒëœ ë‰´ìŠ¤ ì•„ì´í…œë“¤
        let currentWeatherData = null; // í˜„ì¬ ë‚ ì”¨ ë°ì´í„°
        let selectedSchoolData = null; // ì„ íƒëœ í•™êµ ë°ì´í„°
        let currentLocationData = null; // í˜„ì¬ ìœ„ì¹˜ ë°ì´í„°
        let schoolSearchTimeout; // í•™êµ ê²€ìƒ‰ íƒ€ì´ë¨¸

        // AI ë¬¸êµ¬ ìƒì„±
        async function generateNotice() {
            const topic = document.getElementById('ai-topic').value;
            const grade = document.getElementById('ai-grade').value;
            const style = document.getElementById('ai-style').value;
            const responseArea = document.getElementById('ai-response');
            
            // ì…ë ¥ ê²€ì¦
            if (!topic.trim()) {
                showResponse(responseArea, 'ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'error');
                return;
            }

            // ë¡œë”© í‘œì‹œ
            showResponse(responseArea, 'AIê°€ ë¬¸êµ¬ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'loading');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/generate-notice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        topic: topic.trim(),
                        grade: grade || null,
                        style: style || 'normal'
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResponse(responseArea, `âœ… AI ë¬¸êµ¬ ìƒì„± ì™„ë£Œ!\n\nì›ë³¸ ì‘ë‹µ:\n${result.generated.raw}`, 'success');
                    
                    // ìƒì„±ëœ ë¬¸êµ¬ë¥¼ í¸ì§‘ ê°€ëŠ¥í•œ í¼ì— í‘œì‹œ
                    displayGeneratedNotice(result.generated);
                } else {
                    showResponse(responseArea, `âŒ ìƒì„± ì‹¤íŒ¨!\n\n${JSON.stringify(result, null, 2)}`, 'error');
                }
                
            } catch (error) {
                showResponse(responseArea, `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜!\n\n${error.message}`, 'error');
            }
        }

        // ìƒì„±ëœ ë¬¸êµ¬ë¥¼ í¸ì§‘ í¼ì— í‘œì‹œ
        function displayGeneratedNotice(generated) {
            document.getElementById('generated-title').value = generated.title;
            document.getElementById('generated-content').value = generated.content || '';
            setSubItemsToContainer('generated-sub-items-container', generated.subItems || []);
            
            // ìƒì„±ëœ íƒœê·¸ ì„¤ì •
            generatedTags.length = 0;
            generatedTags.push(...generated.tags);
            updateGeneratedTagsDisplay();
            
            // í¸ì§‘ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('generated-notice-section').style.display = 'block';
        }

        // ìƒì„±ëœ ë¬¸êµ¬ì˜ íƒœê·¸ ê´€ë¦¬
        function addGeneratedTag() {
            const input = document.getElementById('generated-tag-input');
            const tag = input.value.trim();
            
            if (tag && !generatedTags.includes(tag)) {
                generatedTags.push(tag);
                updateGeneratedTagsDisplay();
                input.value = '';
            }
        }

        function removeGeneratedTag(tagToRemove) {
            const index = generatedTags.indexOf(tagToRemove);
            if (index > -1) {
                generatedTags.splice(index, 1);
                updateGeneratedTagsDisplay();
            }
        }

        function updateGeneratedTagsDisplay() {
            const display = document.getElementById('generated-tags-display');
            display.innerHTML = generatedTags.map(tag => 
                `<span class="tag" onclick="removeGeneratedTag('${tag}')">${tag} Ã—</span>`
            ).join('');
        }

        // Enter í‚¤ë¡œ ìƒì„±ëœ ë¬¸êµ¬ íƒœê·¸ ì¶”ê°€
        document.addEventListener('DOMContentLoaded', function() {
            const generatedTagInput = document.getElementById('generated-tag-input');
            if (generatedTagInput) {
                generatedTagInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addGeneratedTag();
                    }
                });
            }
        });

        // ìˆ˜ì •ëœ ë¬¸êµ¬ ì €ì¥
        async function saveGeneratedNotice() {
            const title = document.getElementById('generated-title').value;
            const content = document.getElementById('generated-content').value;
            const subItems = getSubItemsFromContainer('generated-sub-items-container');
            const author = document.getElementById('generated-author').value;
            const responseArea = document.getElementById('save-generated-response');
            
            if (!title || (!content && subItems.length === 0)) {
                showResponse(responseArea, 'ì œëª©ê³¼ ë©”ì¸ ë‚´ìš©(ë˜ëŠ” ì„¸ë¶€ í•­ëª©)ì€ í•„ìˆ˜ì…ë‹ˆë‹¤!', 'error');
                return;
            }

            // ë¡œë”© í‘œì‹œ
            showResponse(responseArea, 'ìš”ì²­ ì¤‘...', 'loading');

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/add-notice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        subItems: subItems,
                        tags: generatedTags,
                        author: author || 'ai-generated'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResponse(responseArea, `âœ… ì„±ê³µ!\n\n${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    showResponse(responseArea, `âŒ ì˜¤ë¥˜!\n\n${JSON.stringify(result, null, 2)}`, 'error');
                }
                
            } catch (error) {
                showResponse(responseArea, `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜!\n\n${error.message}`, 'error');
            }
        }

        // ìƒì„±ëœ ë¬¸êµ¬ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        function hideGeneratedSection() {
            document.getElementById('generated-notice-section').style.display = 'none';
            generatedTags.length = 0;
            updateGeneratedTagsDisplay();
            
            // ì‘ë‹µ ì˜ì—­ë„ ìˆ¨ê¸°ê¸°
            const responseArea = document.getElementById('save-generated-response');
            responseArea.style.display = 'none';
        }

        // AI í¼ ì´ˆê¸°í™”
        function clearAIForm() {
            document.getElementById('ai-topic').value = '';
            document.getElementById('ai-grade').value = '';
            document.getElementById('ai-style').value = 'normal';
            
            const responseArea = document.getElementById('ai-response');
            responseArea.style.display = 'none';
            
            hideGeneratedSection();
        }

        // === ë‰´ìŠ¤ ê¸°ë°˜ ë¬¸êµ¬ ìƒì„± ê´€ë ¨ í•¨ìˆ˜ë“¤ ===
        
        // ë‰´ìŠ¤ ê²€ìƒ‰
        async function searchNews() {
            const keyword = document.getElementById('news-search-keyword').value;
            const displayCount = document.getElementById('news-display-count').value;
            const responseArea = document.getElementById('news-search-response');
            
            // ì…ë ¥ ê²€ì¦
            if (!keyword.trim()) {
                showResponse(responseArea, 'ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'error');
                return;
            }

            // ë¡œë”© í‘œì‹œ
            showResponse(responseArea, 'ë‰´ìŠ¤ë¥¼ ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'loading');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/search-news`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: keyword.trim(),
                        display: parseInt(displayCount) || 10
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResponse(responseArea, `âœ… ë‰´ìŠ¤ ê²€ìƒ‰ ì™„ë£Œ! ${result.items.length}ê°œì˜ ê¸°ì‚¬ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`, 'success');
                    
                    // ë‰´ìŠ¤ ëª©ë¡ í‘œì‹œ
                    displayNewsList(result.items);
                } else {
                    showResponse(responseArea, `âŒ ë‰´ìŠ¤ ê²€ìƒ‰ ì‹¤íŒ¨!\n\n${JSON.stringify(result, null, 2)}`, 'error');
                }
                
            } catch (error) {
                showResponse(responseArea, `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜!\n\n${error.message}`, 'error');
            }
        }
        
        // ë‰´ìŠ¤ ëª©ë¡ í‘œì‹œ
        function displayNewsList(newsItems) {
            const container = document.getElementById('news-items-container');
            const section = document.getElementById('news-list-section');
            
            container.innerHTML = '';
            selectedNewsItems = [];
            
            if (newsItems.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">ê²€ìƒ‰ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                section.style.display = 'block';
                return;
            }
            
            // ì„ íƒ ì•ˆë‚´ ë©”ì‹œì§€
            const infoDiv = document.createElement('div');
            infoDiv.className = 'news-selection-info';
            infoDiv.innerHTML = 'ğŸ’¡ ì•Œë¦¼ì¥ ë¬¸êµ¬ ìƒì„±ì— ì‚¬ìš©í•  ë‰´ìŠ¤ë¥¼ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”. (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)';
            container.appendChild(infoDiv);
            
            newsItems.forEach((item, index) => {
                const newsDiv = document.createElement('div');
                newsDiv.className = 'news-item';
                newsDiv.dataset.index = index;
                
                // HTML íƒœê·¸ ì œê±° í•¨ìˆ˜
                const stripHtml = (html) => {
                    const tmp = document.createElement('div');
                    tmp.innerHTML = html;
                    return tmp.textContent || tmp.innerText || '';
                };
                
                newsDiv.innerHTML = `
                    <div class="news-title">${stripHtml(item.title)}</div>
                    <div class="news-description">${stripHtml(item.description)}</div>
                    <div class="news-meta">
                        <span class="news-source">ğŸ“° ë„¤ì´ë²„ë‰´ìŠ¤</span>
                        <span class="news-date">ğŸ“… ${item.postdate}</span>
                    </div>
                `;
                
                newsDiv.addEventListener('click', () => toggleNewsSelection(index, item, newsDiv));
                container.appendChild(newsDiv);
            });
            
            section.style.display = 'block';
            updateGenerateButton();
        }
        
        // ë‰´ìŠ¤ ì„ íƒ í† ê¸€
        function toggleNewsSelection(index, item, element) {
            const existingIndex = selectedNewsItems.findIndex(selected => selected.index === index);
            
            if (existingIndex > -1) {
                // ì„ íƒ í•´ì œ
                selectedNewsItems.splice(existingIndex, 1);
                element.classList.remove('selected');
            } else {
                // ì„ íƒ ì¶”ê°€ (ìµœëŒ€ 3ê°œê¹Œì§€)
                if (selectedNewsItems.length < 3) {
                    selectedNewsItems.push({ index, item });
                    element.classList.add('selected');
                } else {
                    alert('ìµœëŒ€ 3ê°œì˜ ë‰´ìŠ¤ê¹Œì§€ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                }
            }
            
            updateGenerateButton();
        }
        
        // ìƒì„± ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateGenerateButton() {
            const button = document.getElementById('generate-news-notice-btn');
            button.disabled = selectedNewsItems.length === 0;
            button.textContent = selectedNewsItems.length > 0 
                ? `ğŸ¤– ì„ íƒëœ ë‰´ìŠ¤(${selectedNewsItems.length}ê°œ) ê¸°ë°˜ ë¬¸êµ¬ ìƒì„±` 
                : 'ğŸ¤– ë‰´ìŠ¤ ê¸°ë°˜ ë¬¸êµ¬ ìƒì„±';
        }
        
        // ë‰´ìŠ¤ ê¸°ë°˜ ë¬¸êµ¬ ìƒì„±
        async function generateNewsBasedNotice() {
            if (selectedNewsItems.length === 0) {
                alert('ë‰´ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const grade = document.getElementById('news-grade').value;
            const style = document.getElementById('news-style').value;
            const responseArea = document.getElementById('news-search-response');
            
            // ì„ íƒëœ ë‰´ìŠ¤ ë‚´ìš©ì„ ì»¨í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
            const newsContext = selectedNewsItems.map(selected => 
                `ì œëª©: ${selected.item.title}\në‚´ìš©: ${selected.item.description}`
            ).join('\n\n');
            
            // ë¡œë”© í‘œì‹œ
            showResponse(responseArea, 'ì„ íƒëœ ë‰´ìŠ¤ë¥¼ ë¶„ì„í•˜ì—¬ AIê°€ ë¬¸êµ¬ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'loading');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/generate-notice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        topic: 'ë‰´ìŠ¤ ê¸°ë°˜ êµìœ¡ ì•ˆë‚´',  // ê¸°ë³¸ ì£¼ì œ
                        context: newsContext,          // ë‰´ìŠ¤ ë‚´ìš©ì„ ì»¨í…ìŠ¤íŠ¸ë¡œ
                        grade: grade || null,
                        style: style || 'normal'
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResponse(responseArea, `âœ… ë‰´ìŠ¤ ê¸°ë°˜ AI ë¬¸êµ¬ ìƒì„± ì™„ë£Œ!`, 'success');
                    
                    // ìƒì„±ëœ ë¬¸êµ¬ë¥¼ í¸ì§‘ ê°€ëŠ¥í•œ í¼ì— í‘œì‹œ
                    displayNewsGeneratedNotice(result.generated, selectedNewsItems);
                } else {
                    showResponse(responseArea, `âŒ ìƒì„± ì‹¤íŒ¨!\n\n${JSON.stringify(result, null, 2)}`, 'error');
                }
                
            } catch (error) {
                showResponse(responseArea, `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜!\n\n${error.message}`, 'error');
            }
        }
        
        // ë‰´ìŠ¤ ê¸°ë°˜ ìƒì„±ëœ ë¬¸êµ¬ë¥¼ í¸ì§‘ í¼ì— í‘œì‹œ
        function displayNewsGeneratedNotice(generated, newsSourceItems) {
            document.getElementById('news-generated-title').value = generated.title;
            document.getElementById('news-generated-content').value = generated.content || '';
            setSubItemsToContainer('news-generated-sub-items-container', generated.subItems || []);
            
            // ìƒì„±ëœ íƒœê·¸ ì„¤ì •
            newsGeneratedTags.length = 0;
            newsGeneratedTags.push(...generated.tags);
            updateNewsGeneratedTagsDisplay();
            
            // ë‰´ìŠ¤ ì†ŒìŠ¤ ì •ë³´ í‘œì‹œ
            const sourceInfo = document.getElementById('news-source-info');
            const stripHtml = (html) => {
                const tmp = document.createElement('div');
                tmp.innerHTML = html;
                return tmp.textContent || tmp.innerText || '';
            };
            
            sourceInfo.innerHTML = newsSourceItems.map(source => 
                `ğŸ“° ${stripHtml(source.item.title)} (ë„¤ì´ë²„ë‰´ìŠ¤)`
            ).join('<br>');
            
            // í¸ì§‘ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('news-generated-notice-section').style.display = 'block';
        }
        
        // ë‰´ìŠ¤ ê¸°ë°˜ ìƒì„±ëœ ë¬¸êµ¬ì˜ íƒœê·¸ ê´€ë¦¬
        function addNewsGeneratedTag() {
            const input = document.getElementById('news-generated-tag-input');
            const tag = input.value.trim();
            
            if (tag && !newsGeneratedTags.includes(tag)) {
                newsGeneratedTags.push(tag);
                updateNewsGeneratedTagsDisplay();
                input.value = '';
            }
        }

        function removeNewsGeneratedTag(tagToRemove) {
            const index = newsGeneratedTags.indexOf(tagToRemove);
            if (index > -1) {
                newsGeneratedTags.splice(index, 1);
                updateNewsGeneratedTagsDisplay();
            }
        }

        function updateNewsGeneratedTagsDisplay() {
            const display = document.getElementById('news-generated-tags-display');
            display.innerHTML = newsGeneratedTags.map(tag => 
                `<span class="tag" onclick="removeNewsGeneratedTag('${tag}')">${tag} Ã—</span>`
            ).join('');
        }
        
        // ë‰´ìŠ¤ ê¸°ë°˜ ìˆ˜ì •ëœ ë¬¸êµ¬ ì €ì¥
        async function saveNewsGeneratedNotice() {
            const title = document.getElementById('news-generated-title').value;
            const content = document.getElementById('news-generated-content').value;
            const subItems = getSubItemsFromContainer('news-generated-sub-items-container');
            const author = document.getElementById('news-generated-author').value;
            const responseArea = document.getElementById('save-news-generated-response');
            
            if (!title || (!content && subItems.length === 0)) {
                showResponse(responseArea, 'ì œëª©ê³¼ ë©”ì¸ ë‚´ìš©(ë˜ëŠ” ì„¸ë¶€ í•­ëª©)ì€ í•„ìˆ˜ì…ë‹ˆë‹¤!', 'error');
                return;
            }

            // ë¡œë”© í‘œì‹œ
            showResponse(responseArea, 'ìš”ì²­ ì¤‘...', 'loading');

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/add-notice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        subItems: subItems,
                        tags: newsGeneratedTags,
                        author: author || 'news-ai-generated'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResponse(responseArea, `âœ… ì„±ê³µ!\n\n${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    showResponse(responseArea, `âŒ ì˜¤ë¥˜!\n\n${JSON.stringify(result, null, 2)}`, 'error');
                }
                
            } catch (error) {
                showResponse(responseArea, `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜!\n\n${error.message}`, 'error');
            }
        }
        
        // ë‰´ìŠ¤ ê¸°ë°˜ ìƒì„±ëœ ë¬¸êµ¬ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        function hideNewsGeneratedSection() {
            document.getElementById('news-generated-notice-section').style.display = 'none';
            newsGeneratedTags.length = 0;
            updateNewsGeneratedTagsDisplay();
            
            // ì‘ë‹µ ì˜ì—­ë„ ìˆ¨ê¸°ê¸°
            const responseArea = document.getElementById('save-news-generated-response');
            responseArea.style.display = 'none';
        }
        
        // ë‰´ìŠ¤ í¼ ì´ˆê¸°í™”
        function clearNewsForm() {
            document.getElementById('news-search-keyword').value = '';
            document.getElementById('news-display-count').value = '10';
            document.getElementById('news-grade').value = '';
            document.getElementById('news-style').value = 'normal';
            
            // ë‰´ìŠ¤ ëª©ë¡ ìˆ¨ê¸°ê¸°
            document.getElementById('news-list-section').style.display = 'none';
            selectedNewsItems = [];
            updateGenerateButton();
            
            // ì‘ë‹µ ì˜ì—­ ìˆ¨ê¸°ê¸°
            const responseArea = document.getElementById('news-search-response');
            responseArea.style.display = 'none';
            
            hideNewsGeneratedSection();
        }
        
        // Enter í‚¤ë¡œ ë‰´ìŠ¤ ê¸°ë°˜ ìƒì„±ëœ ë¬¸êµ¬ íƒœê·¸ ì¶”ê°€
        document.addEventListener('DOMContentLoaded', function() {
            const newsGeneratedTagInput = document.getElementById('news-generated-tag-input');
            if (newsGeneratedTagInput) {
                newsGeneratedTagInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addNewsGeneratedTag();
                    }
                });
            }
            
            const weatherGeneratedTagInput = document.getElementById('weather-generated-tag-input');
            if (weatherGeneratedTagInput) {
                weatherGeneratedTagInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addWeatherGeneratedTag();
                    }
                });
            }
        });

        // === ë‚ ì”¨ ê¸°ë°˜ ë¬¸êµ¬ ìƒì„± ê´€ë ¨ í•¨ìˆ˜ë“¤ ===
        
        // ë‚ ì”¨ ì •ë³´ ì¡°íšŒ
        async function getWeatherInfo() {
            const location = document.getElementById('weather-location').value;
            const detailLocation = document.getElementById('weather-detail-location').value;
            const responseArea = document.getElementById('weather-info-response');
            
            // ì…ë ¥ ê²€ì¦
            if (!location) {
                showResponse(responseArea, 'ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”!', 'error');
                return;
            }

            // ë¡œë”© í‘œì‹œ
            showResponse(responseArea, 'ë‚ ì”¨ ì •ë³´ë¥¼ ì¡°íšŒ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'loading');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/get-weather`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        location: location,
                        detailLocation: detailLocation || null
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResponse(responseArea, `âœ… ë‚ ì”¨ ì •ë³´ ì¡°íšŒ ì™„ë£Œ!`, 'success');
                    currentWeatherData = result.weather;
                    
                    // ë‚ ì”¨ ì •ë³´ í‘œì‹œ
                    displayWeatherInfo(result.weather);
                } else {
                    showResponse(responseArea, `âŒ ë‚ ì”¨ ì¡°íšŒ ì‹¤íŒ¨!\n\n${JSON.stringify(result, null, 2)}`, 'error');
                }
                
            } catch (error) {
                showResponse(responseArea, `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜!\n\n${error.message}`, 'error');
            }
        }
        
        // ë‚ ì”¨ ì •ë³´ í‘œì‹œ
        function displayWeatherInfo(weather) {
            const container = document.getElementById('weather-display-container');
            const section = document.getElementById('weather-info-section');
            
            container.innerHTML = '';
            
            // ë‚ ì”¨ ì•„ì´ì½˜ ë§¤í•‘
            const getWeatherIcon = (condition) => {
                const iconMap = {
                    'ë§‘ìŒ': 'â˜€ï¸',
                    'êµ¬ë¦„ë§ìŒ': 'â›…',
                    'íë¦¼': 'â˜ï¸',
                    'ë¹„': 'ğŸŒ§ï¸',
                    'ëˆˆ': 'â„ï¸',
                    'ë‡Œìš°': 'â›ˆï¸',
                    'ì•ˆê°œ': 'ğŸŒ«ï¸'
                };
                return iconMap[condition] || 'ğŸŒ¤ï¸';
            };
            
            const weatherCard = document.createElement('div');
            weatherCard.className = 'weather-info-card';
            
            weatherCard.innerHTML = `
                <div class="weather-main">
                    <div class="weather-icon">${getWeatherIcon(weather.condition)}</div>
                    <div>
                        <div class="weather-temp">${weather.temperature}Â°C</div>
                        <div class="weather-desc">${weather.condition}</div>
                        <div class="weather-location">ğŸ“ ${weather.location}</div>
                    </div>
                </div>
                
                <div class="weather-details">
                    <div class="weather-detail-item">
                        <div class="weather-detail-label">ì²´ê°ì˜¨ë„</div>
                        <div class="weather-detail-value">${weather.feelsLike || weather.temperature}Â°C</div>
                    </div>
                    <div class="weather-detail-item">
                        <div class="weather-detail-label">ìŠµë„</div>
                        <div class="weather-detail-value">${weather.humidity || 'N/A'}%</div>
                    </div>
                    <div class="weather-detail-item">
                        <div class="weather-detail-label">í’ì†</div>
                        <div class="weather-detail-value">${weather.windSpeed || 'N/A'}m/s</div>
                    </div>
                    <div class="weather-detail-item">
                        <div class="weather-detail-label">ê°•ìˆ˜í™•ë¥ </div>
                        <div class="weather-detail-value">${weather.rainProbability || 'N/A'}%</div>
                    </div>
                </div>
                
                ${weather.alerts ? `<div class="weather-alert">âš ï¸ ê¸°ìƒíŠ¹ë³´: ${weather.alerts}</div>` : ''}
            `;
            
            container.appendChild(weatherCard);
            section.style.display = 'block';
            updateWeatherGenerateButton();
        }
        
        // ë‚ ì”¨ ê¸°ë°˜ ë¬¸êµ¬ ìƒì„± ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateWeatherGenerateButton() {
            const button = document.getElementById('generate-weather-notice-btn');
            button.disabled = !currentWeatherData;
            button.textContent = currentWeatherData 
                ? `ğŸ¤– í˜„ì¬ ë‚ ì”¨ ê¸°ë°˜ ë¬¸êµ¬ ìƒì„±` 
                : 'ğŸ¤– ë‚ ì”¨ ê¸°ë°˜ ë¬¸êµ¬ ìƒì„±';
        }
        
        // ë‚ ì”¨ ê¸°ë°˜ ë¬¸êµ¬ ìƒì„±
        async function generateWeatherBasedNotice() {
            if (!currentWeatherData) {
                alert('ë¨¼ì € ë‚ ì”¨ ì •ë³´ë¥¼ ì¡°íšŒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const grade = document.getElementById('weather-grade').value;
            const style = document.getElementById('weather-style').value;
            const focus = document.getElementById('weather-focus').value;
            const responseArea = document.getElementById('weather-info-response');
            
            // ë‚ ì”¨ ì •ë³´ë¥¼ ì»¨í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
            const weatherContext = formatWeatherContext(currentWeatherData, focus);
            
            // ë¡œë”© í‘œì‹œ
            showResponse(responseArea, 'ë‚ ì”¨ ì •ë³´ë¥¼ ë¶„ì„í•˜ì—¬ AIê°€ ë¬¸êµ¬ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'loading');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/generate-notice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        topic: getFocusBasedTopic(focus),
                        context: weatherContext,
                        grade: grade || null,
                        style: style || 'normal'
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResponse(responseArea, `âœ… ë‚ ì”¨ ê¸°ë°˜ AI ë¬¸êµ¬ ìƒì„± ì™„ë£Œ!`, 'success');
                    
                    // ìƒì„±ëœ ë¬¸êµ¬ë¥¼ í¸ì§‘ ê°€ëŠ¥í•œ í¼ì— í‘œì‹œ
                    displayWeatherGeneratedNotice(result.generated, currentWeatherData);
                } else {
                    showResponse(responseArea, `âŒ ìƒì„± ì‹¤íŒ¨!\n\n${JSON.stringify(result, null, 2)}`, 'error');
                }
                
            } catch (error) {
                showResponse(responseArea, `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜!\n\n${error.message}`, 'error');
            }
        }
        
        // ë‚ ì”¨ ì •ë³´ë¥¼ ì»¨í…ìŠ¤íŠ¸ ë¬¸ìì—´ë¡œ ë³€í™˜
        function formatWeatherContext(weather, focus) {
            let context = `í˜„ì¬ ë‚ ì”¨ ì •ë³´:
ì§€ì—­: ${weather.location}
ë‚ ì”¨: ${weather.condition}
ê¸°ì˜¨: ${weather.temperature}Â°C
ì²´ê°ì˜¨ë„: ${weather.feelsLike || weather.temperature}Â°C`;

            if (weather.humidity) context += `\nìŠµë„: ${weather.humidity}%`;
            if (weather.windSpeed) context += `\ní’ì†: ${weather.windSpeed}m/s`;
            if (weather.rainProbability) context += `\nê°•ìˆ˜í™•ë¥ : ${weather.rainProbability}%`;
            if (weather.alerts) context += `\nê¸°ìƒíŠ¹ë³´: ${weather.alerts}`;
            
            // ì´ˆì  ì˜ì—­ì— ë”°ë¥¸ ì¶”ê°€ ì»¨í…ìŠ¤íŠ¸
            switch (focus) {
                case 'safety':
                    context += '\n\nì•ˆì „ ê´€ë ¨ ì£¼ì˜ì‚¬í•­ì— ì¤‘ì ì„ ë‘ì–´ ì•Œë¦¼ì¥ ë¬¸êµ¬ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.';
                    break;
                case 'health':
                    context += '\n\nê±´ê°• ê´€ë¦¬ ë° ì ì ˆí•œ ì˜·ì°¨ë¦¼ì— ì¤‘ì ì„ ë‘ì–´ ì•Œë¦¼ì¥ ë¬¸êµ¬ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.';
                    break;
                case 'activity':
                    context += '\n\nì‹¤ë‚´ì™¸ í™œë™ ì¡°ì • ë° ê¶Œì¥ì‚¬í•­ì— ì¤‘ì ì„ ë‘ì–´ ì•Œë¦¼ì¥ ë¬¸êµ¬ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.';
                    break;
                default:
                    context += '\n\nì¢…í•©ì ì¸ ë‚ ì”¨ ëŒ€ì‘ ë°©ì•ˆì„ í¬í•¨í•œ ì•Œë¦¼ì¥ ë¬¸êµ¬ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.';
            }
            
            return context;
        }
        
        // ì´ˆì  ì˜ì—­ì— ë”°ë¥¸ ì£¼ì œ ìƒì„±
        function getFocusBasedTopic(focus) {
            switch (focus) {
                case 'safety': return 'ë‚ ì”¨ ì•ˆì „ ìˆ˜ì¹™';
                case 'health': return 'ë‚ ì”¨ë³„ ê±´ê°• ê´€ë¦¬';
                case 'activity': return 'ë‚ ì”¨ì— ë§ëŠ” í™œë™ ì•ˆë‚´';
                default: return 'ì˜¤ëŠ˜ì˜ ë‚ ì”¨ ì•ˆë‚´';
            }
        }
        
        // ë‚ ì”¨ ê¸°ë°˜ ìƒì„±ëœ ë¬¸êµ¬ë¥¼ í¸ì§‘ í¼ì— í‘œì‹œ
        function displayWeatherGeneratedNotice(generated, weatherData) {
            document.getElementById('weather-generated-title').value = generated.title;
            document.getElementById('weather-generated-content').value = generated.content || '';
            setSubItemsToContainer('weather-generated-sub-items-container', generated.subItems || []);
            
            // ìƒì„±ëœ íƒœê·¸ ì„¤ì •
            weatherGeneratedTags.length = 0;
            weatherGeneratedTags.push(...generated.tags);
            updateWeatherGeneratedTagsDisplay();
            
            // ë‚ ì”¨ ì†ŒìŠ¤ ì •ë³´ í‘œì‹œ
            const sourceInfo = document.getElementById('weather-source-info');
            sourceInfo.innerHTML = `ğŸŒ¤ï¸ ${weatherData.location} - ${weatherData.condition}, ${weatherData.temperature}Â°C`;
            
            // í¸ì§‘ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('weather-generated-notice-section').style.display = 'block';
        }
        
        // ë‚ ì”¨ ê¸°ë°˜ ìƒì„±ëœ ë¬¸êµ¬ì˜ íƒœê·¸ ê´€ë¦¬
        function addWeatherGeneratedTag() {
            const input = document.getElementById('weather-generated-tag-input');
            const tag = input.value.trim();
            
            if (tag && !weatherGeneratedTags.includes(tag)) {
                weatherGeneratedTags.push(tag);
                updateWeatherGeneratedTagsDisplay();
                input.value = '';
            }
        }

        function removeWeatherGeneratedTag(tagToRemove) {
            const index = weatherGeneratedTags.indexOf(tagToRemove);
            if (index > -1) {
                weatherGeneratedTags.splice(index, 1);
                updateWeatherGeneratedTagsDisplay();
            }
        }

        function updateWeatherGeneratedTagsDisplay() {
            const display = document.getElementById('weather-generated-tags-display');
            display.innerHTML = weatherGeneratedTags.map(tag => 
                `<span class="tag" onclick="removeWeatherGeneratedTag('${tag}')">${tag} Ã—</span>`
            ).join('');
        }
        
        // ë‚ ì”¨ ê¸°ë°˜ ìˆ˜ì •ëœ ë¬¸êµ¬ ì €ì¥
        async function saveWeatherGeneratedNotice() {
            const title = document.getElementById('weather-generated-title').value;
            const content = document.getElementById('weather-generated-content').value;
            const subItems = getSubItemsFromContainer('weather-generated-sub-items-container');
            const author = document.getElementById('weather-generated-author').value;
            const responseArea = document.getElementById('save-weather-generated-response');
            
            if (!title || (!content && subItems.length === 0)) {
                showResponse(responseArea, 'ì œëª©ê³¼ ë©”ì¸ ë‚´ìš©(ë˜ëŠ” ì„¸ë¶€ í•­ëª©)ì€ í•„ìˆ˜ì…ë‹ˆë‹¤!', 'error');
                return;
            }

            // ë¡œë”© í‘œì‹œ
            showResponse(responseArea, 'ìš”ì²­ ì¤‘...', 'loading');

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/add-notice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        content: content,
                        subItems: subItems,
                        tags: weatherGeneratedTags,
                        author: author || 'weather-ai-generated'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResponse(responseArea, `âœ… ì„±ê³µ!\n\n${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    showResponse(responseArea, `âŒ ì˜¤ë¥˜!\n\n${JSON.stringify(result, null, 2)}`, 'error');
                }
                
            } catch (error) {
                showResponse(responseArea, `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜!\n\n${error.message}`, 'error');
            }
        }
        
        // ë‚ ì”¨ ê¸°ë°˜ ìƒì„±ëœ ë¬¸êµ¬ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        function hideWeatherGeneratedSection() {
            document.getElementById('weather-generated-notice-section').style.display = 'none';
            weatherGeneratedTags.length = 0;
            updateWeatherGeneratedTagsDisplay();
            
            // ì‘ë‹µ ì˜ì—­ë„ ìˆ¨ê¸°ê¸°
            const responseArea = document.getElementById('save-weather-generated-response');
            responseArea.style.display = 'none';
        }
        
        // ë‚ ì”¨ í¼ ì´ˆê¸°í™”
        function clearWeatherForm() {
            document.getElementById('weather-location').value = '';
            document.getElementById('weather-detail-location').value = '';
            document.getElementById('weather-grade').value = '';
            document.getElementById('weather-style').value = 'normal';
            document.getElementById('weather-focus').value = 'safety';
            
            // ë‚ ì”¨ ì •ë³´ ìˆ¨ê¸°ê¸°
            document.getElementById('weather-info-section').style.display = 'none';
            currentWeatherData = null;
            updateWeatherGenerateButton();
            
            // ì‘ë‹µ ì˜ì—­ ìˆ¨ê¸°ê¸°
            const responseArea = document.getElementById('weather-info-response');
            responseArea.style.display = 'none';
            
            hideWeatherGeneratedSection();
        }

        // === í•™êµ ê²€ìƒ‰ + ë‚ ì”¨ ì›Œí¬í”Œë¡œìš° ê´€ë ¨ í•¨ìˆ˜ë“¤ ===
        
        // í•™êµ ê²€ìƒ‰ ìë™ì™„ì„± ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            const schoolSearchInput = document.getElementById('school-search-input');
            if (schoolSearchInput) {
                schoolSearchInput.addEventListener('input', function(e) {
                    const query = e.target.value.trim();
                    
                    clearTimeout(schoolSearchTimeout);
                    
                    if (query.length >= 2) {
                        schoolSearchTimeout = setTimeout(() => {
                            searchSchoolsAutocomplete(query);
                        }, 500);
                    } else {
                        hideSchoolSuggestions();
                    }
                });
            }
            
            // ì™¸ë¶€ í´ë¦­ ì‹œ ìë™ì™„ì„± ìˆ¨ê¸°ê¸°
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#school-search-input') && !e.target.closest('#school-suggestions')) {
                    hideSchoolSuggestions();
                }
            });
        });
        
        // í•™êµ ìë™ì™„ì„± ê²€ìƒ‰
        async function searchSchoolsAutocomplete(query) {
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/search-schools`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        schoolName: query,
                        limit: 10
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    displaySchoolSuggestions(result.schools);
                } else {
                    hideSchoolSuggestions();
                }
                
            } catch (error) {
                console.error('í•™êµ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                hideSchoolSuggestions();
            }
        }
        
        // í•™êµ ìë™ì™„ì„± ì œì•ˆ í‘œì‹œ
        function displaySchoolSuggestions(schools) {
            const suggestionsContainer = document.getElementById('school-suggestions');
            
            if (schools.length === 0) {
                hideSchoolSuggestions();
                return;
            }
            
            suggestionsContainer.innerHTML = '';
            
            schools.forEach(school => {
                const suggestionItem = document.createElement('div');
                suggestionItem.style.cssText = `
                    padding: 10px;
                    cursor: pointer;
                    border-bottom: 1px solid #f0f0f0;
                    transition: background-color 0.2s;
                `;
                
                suggestionItem.innerHTML = `
                    <div style="font-weight: bold; color: #333; margin-bottom: 3px;">${school.SCHUL_NM}</div>
                    <div style="font-size: 12px; color: #666;">${school.SCHUL_KND_SC_NM} | ${school.LCTN_SC_NM} | ${school.ORG_RDNMA || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}</div>
                `;
                
                suggestionItem.addEventListener('mouseenter', () => {
                    suggestionItem.style.backgroundColor = '#f5f5f5';
                });
                
                suggestionItem.addEventListener('mouseleave', () => {
                    suggestionItem.style.backgroundColor = 'white';
                });
                
                suggestionItem.addEventListener('click', () => {
                    selectSchool(school);
                });
                
                suggestionsContainer.appendChild(suggestionItem);
            });
            
            suggestionsContainer.style.display = 'block';
        }
        
        // í•™êµ ì„ íƒ
        function selectSchool(school) {
            document.getElementById('school-search-input').value = school.SCHUL_NM;
            hideSchoolSuggestions();
            
            selectedSchoolData = school;
            displaySelectedSchool(school);
            updateWorkflowStep(1, 'completed');
            updateWorkflowStep(2, 'active');
            
            // ì „ì²´ í”„ë¡œì„¸ìŠ¤ ë²„íŠ¼ í™œì„±í™”
            document.getElementById('run-school-workflow-btn').disabled = false;
        }
        
        // ì„ íƒëœ í•™êµ ì •ë³´ í‘œì‹œ
        function displaySelectedSchool(school) {
            const container = document.getElementById('selected-school-display');
            const details = document.getElementById('selected-school-details');
            
            details.innerHTML = `
                <div style="margin-bottom: 5px;"><strong>ğŸ« í•™êµëª…:</strong> ${school.SCHUL_NM}</div>
                <div style="margin-bottom: 5px;"><strong>ğŸ“ ì£¼ì†Œ:</strong> ${school.ORG_RDNMA || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}</div>
                <div style="margin-bottom: 5px;"><strong>ğŸ“ ìœ í˜•:</strong> ${school.SCHUL_KND_SC_NM}</div>
                <div><strong>ğŸ—ºï¸ ì§€ì—­:</strong> ${school.LCTN_SC_NM} (ì½”ë“œ: ${school.ATPT_OFCDC_SC_CODE})</div>
            `;
            
            container.style.display = 'block';
        }
        
        // ìë™ì™„ì„± ìˆ¨ê¸°ê¸°
        function hideSchoolSuggestions() {
            document.getElementById('school-suggestions').style.display = 'none';
        }
        
        // ì›Œí¬í”Œë¡œìš° ë‹¨ê³„ ì—…ë°ì´íŠ¸
        function updateWorkflowStep(stepNumber, status) {
            const step = document.getElementById(`school-step-${stepNumber}`);
            if (!step) return;
            
            // ëª¨ë“  ë‹¨ê³„ ì´ˆê¸°í™”
            for (let i = 1; i <= 4; i++) {
                const s = document.getElementById(`school-step-${i}`);
                if (s) {
                    s.style.background = '#f5f5f5';
                    s.querySelector('div').style.color = '#666';
                }
            }
            
            // ì™„ë£Œëœ ë‹¨ê³„ë“¤ í‘œì‹œ
            for (let i = 1; i < stepNumber; i++) {
                const s = document.getElementById(`school-step-${i}`);
                if (s) {
                    s.style.background = '#c8e6c9';
                    s.querySelector('div').style.color = '#2e7d32';
                }
            }
            
            // í˜„ì¬ ë‹¨ê³„ í‘œì‹œ
            if (status === 'active') {
                step.style.background = '#e3f2fd';
                step.querySelector('div').style.color = '#1976d2';
            } else if (status === 'completed') {
                step.style.background = '#c8e6c9';
                step.querySelector('div').style.color = '#2e7d32';
            } else if (status === 'processing') {
                step.style.background = '#fff3e0';
                step.querySelector('div').style.color = '#f57c00';
            }
        }
        
        // ì „ì²´ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
        async function runSchoolWeatherWorkflow() {
            if (!selectedSchoolData?.ORG_RDNMA) {
                alert('ë¨¼ì € í•™êµë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const responseArea = document.getElementById('school-workflow-response');
            showResponse(responseArea, 'í•™êµ â†’ ìœ„ì¹˜ â†’ ë‚ ì”¨ â†’ ê³µì§€ì‚¬í•­ ìƒì„± í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...', 'loading');
            
            try {
                // 2ë‹¨ê³„: ìœ„ì¹˜ ì •ë³´ ì¡°íšŒ
                updateWorkflowStep(2, 'processing');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const locationResponse = await fetch(`${SUPABASE_URL}/functions/v1/geocode-address`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        address: selectedSchoolData.ORG_RDNMA
                    })
                });

                const locationResult = await locationResponse.json();
                
                if (!locationResponse.ok || !locationResult.success) {
                    throw new Error('ìœ„ì¹˜ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: ' + (locationResult.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
                
                currentLocationData = locationResult.location;
                displayLocationInfo(currentLocationData);
                updateWorkflowStep(2, 'completed');
                updateWorkflowStep(3, 'active');
                
                // 3ë‹¨ê³„: ë‚ ì”¨ ì •ë³´ ì¡°íšŒ
                updateWorkflowStep(3, 'processing');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const weatherResponse = await fetch(`${SUPABASE_URL}/functions/v1/get-weather-by-grid`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lat: currentLocationData.latitude,
                        lng: currentLocationData.longitude,
                        address: selectedSchoolData.SCHUL_NM
                    })
                });

                const weatherResult = await weatherResponse.json();
                
                if (!weatherResponse.ok || !weatherResult.success) {
                    throw new Error('ë‚ ì”¨ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: ' + (weatherResult.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
                
                currentWeatherData = weatherResult.weather;
                displaySchoolWeatherInfo(currentWeatherData);
                updateWorkflowStep(3, 'completed');
                updateWorkflowStep(4, 'active');
                
                // 4ë‹¨ê³„: ë‚ ì”¨ ê¸°ë°˜ ê³µì§€ì‚¬í•­ í‘œì‹œ
                updateWorkflowStep(4, 'processing');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë‚ ì”¨ ê¸°ë°˜ ê³µì§€ì‚¬í•­ ìƒì„±
                console.log('[í•™êµ ì›Œí¬í”Œë¡œìš°] 4ë‹¨ê³„: ë‚ ì”¨ ê¸°ë°˜ ê³µì§€ì‚¬í•­ ìƒì„± ì‹œì‘', currentWeatherData);
                
                const generatedNotices = generateWeatherNoticesFromData(currentWeatherData);
                console.log('[í•™êµ ì›Œí¬í”Œë¡œìš°] 4ë‹¨ê³„: ìƒì„±ëœ ê³µì§€ì‚¬í•­', generatedNotices);

                if (generatedNotices && generatedNotices.length > 0) {
                    displaySchoolNotices(generatedNotices);
                    updateWorkflowStep(4, 'completed');
                    showResponse(responseArea, 'âœ… ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ!\ní•™êµ â†’ ìœ„ì¹˜ â†’ ë‚ ì”¨ â†’ ê³µì§€ì‚¬í•­ ìƒì„±ì´ ëª¨ë‘ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    throw new Error('ë‚ ì”¨ ê¸°ë°˜ ê³µì§€ì‚¬í•­ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                showResponse(responseArea, `âŒ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜!\n\n${error.message}`, 'error');
                console.error('School workflow error:', error);
            }
        }
        
        // ìœ„ì¹˜ ì •ë³´ í‘œì‹œ
        function displayLocationInfo(location) {
            const container = document.getElementById('location-info-display');
            const details = document.getElementById('location-details');
            
            details.innerHTML = `
                <div style="margin-bottom: 5px;"><strong>ğŸ“ ì£¼ì†Œ:</strong> ${location.address}</div>
                <div style="margin-bottom: 5px;"><strong>ğŸŒ ì¢Œí‘œ:</strong> ${location.latitude}, ${location.longitude}</div>
                <div><strong>ğŸ“ ê¸°ìƒì²­ ê²©ì:</strong> nx=${location.gridX}, ny=${location.gridY}</div>
            `;
            
            container.style.display = 'block';
        }
        
        // í•™êµ ë‚ ì”¨ ì •ë³´ í‘œì‹œ
        function displaySchoolWeatherInfo(weather) {
            const container = document.getElementById('school-weather-info-display');
            const details = document.getElementById('school-weather-details');
            
            // ë‚ ì”¨ ì•„ì´ì½˜ ë§¤í•‘
            const getWeatherIcon = (condition) => {
                const iconMap = {
                    'ë§‘ìŒ': 'â˜€ï¸',
                    'êµ¬ë¦„ë§ìŒ': 'â›…',
                    'íë¦¼': 'â˜ï¸',
                    'ë¹„': 'ğŸŒ§ï¸',
                    'ëˆˆ': 'â„ï¸',
                    'clear': 'â˜€ï¸',
                    'partly_cloudy': 'â›…',
                    'cloudy': 'â˜ï¸',
                    'rainy': 'ğŸŒ§ï¸',
                    'snowy': 'â„ï¸'
                };
                return iconMap[condition] || 'ğŸŒ¤ï¸';
            };
            
            details.innerHTML = `
                <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
                    <div style="font-size: 48px;">${getWeatherIcon(weather.skyCondition || weather.skyDescription)}</div>
                    <div>
                        <div style="font-size: 36px; font-weight: bold; margin-bottom: 5px;">${weather.temperature}Â°C</div>
                        <div style="font-size: 18px; margin-bottom: 5px;">${weather.skyDescription}</div>
                        <div style="font-size: 14px; opacity: 0.9;">ğŸ“ ${weather.address || 'í˜„ì¬ ìœ„ì¹˜'}</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 12px; opacity: 0.8;">ìŠµë„</div>
                        <div style="font-weight: bold; font-size: 16px;">${weather.humidity || 'N/A'}%</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 12px; opacity: 0.8;">í’ì†</div>
                        <div style="font-weight: bold; font-size: 16px;">${weather.windSpeed || 'N/A'}m/s</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 12px; opacity: 0.8;">ê°•ìˆ˜ëŸ‰</div>
                        <div style="font-weight: bold; font-size: 16px;">${weather.precipitation || 'N/A'}mm</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px; text-align: center;">
                        <div style="font-size: 12px; opacity: 0.8;">ê°•ìˆ˜í˜•íƒœ</div>
                        <div style="font-weight: bold; font-size: 16px;">${weather.precipitationDescription}</div>
                    </div>
                </div>
            `;
            
            container.style.display = 'block';
        }
        
        // í•™êµ ê³µì§€ì‚¬í•­ í‘œì‹œ
        function displaySchoolNotices(notices) {
            const container = document.getElementById('school-notices-display');
            const noticesContainer = document.getElementById('school-notices-container');
            
            noticesContainer.innerHTML = '';
            
            const priorityText = {
                1: 'ê¸´ê¸‰',
                2: 'ì£¼ì˜', 
                3: 'ì •ë³´'
            };
            
            const priorityColors = {
                1: '#f44336',
                2: '#ff9800',
                3: '#4caf50'
            };
            
            notices.forEach(notice => {
                const noticeCard = document.createElement('div');
                noticeCard.style.cssText = `
                    background: white;
                    border: 1px solid ${priorityColors[notice.priority]};
                    border-left: 4px solid ${priorityColors[notice.priority]};
                    border-radius: 8px;
                    padding: 15px;
                    margin-bottom: 15px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                `;
                
                noticeCard.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 24px;">${notice.icon}</span>
                        <h4 style="margin: 0; color: #333; flex: 1;">${notice.title}</h4>
                        <span style="background: ${priorityColors[notice.priority]}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                            ${priorityText[notice.priority]}
                        </span>
                    </div>
                    <div style="color: #555; line-height: 1.6; margin-bottom: 10px;">
                        ${notice.content}
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #888;">
                        <span>ì¹´í…Œê³ ë¦¬: ${notice.category}</span>
                        <span>ë‚ ì§œ: ${notice.date}</span>
                    </div>
                `;
                
                noticesContainer.appendChild(noticeCard);
            });
            
            container.style.display = 'block';
        }
        
        // í•™êµ ì›Œí¬í”Œë¡œìš° ì´ˆê¸°í™”
        function clearSchoolWorkflow() {
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('school-search-input').value = '';
            hideSchoolSuggestions();
            
            // ë°ì´í„° ì´ˆê¸°í™”
            selectedSchoolData = null;
            currentLocationData = null;
            currentWeatherData = null;
            
            // í‘œì‹œ ì˜ì—­ ìˆ¨ê¸°ê¸°
            document.getElementById('selected-school-display').style.display = 'none';
            document.getElementById('location-info-display').style.display = 'none';
            document.getElementById('school-weather-info-display').style.display = 'none';
            document.getElementById('school-notices-display').style.display = 'none';
            
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            document.getElementById('run-school-workflow-btn').disabled = true;
            
            // ì›Œí¬í”Œë¡œìš° ë‹¨ê³„ ì´ˆê¸°í™”
            updateWorkflowStep(1, 'active');
            
            // ì‘ë‹µ ì˜ì—­ ìˆ¨ê¸°ê¸°
            const responseArea = document.getElementById('school-workflow-response');
            responseArea.style.display = 'none';
        }

        // === ë…ë¦½ì ì¸ í•™êµ ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤ ===
        
        // í•™êµ ê²€ìƒ‰ í…ŒìŠ¤íŠ¸
        async function testSchoolSearch() {
            const schoolName = document.getElementById('school-name-search').value;
            const limit = parseInt(document.getElementById('school-search-limit').value);
            const responseArea = document.getElementById('school-search-response');
            
            // ì…ë ¥ ê²€ì¦
            if (!schoolName.trim()) {
                showResponse(responseArea, 'í•™êµëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'error');
                return;
            }

            // ë¡œë”© í‘œì‹œ
            showResponse(responseArea, 'í•™êµë¥¼ ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...', 'loading');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/search-schools`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        schoolName: schoolName,
                        limit: limit
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    const detailedResults = result.schools.map(school => ({
                        í•™êµëª…: school.SCHUL_NM,
                        ì£¼ì†Œ: school.ORG_RDNMA || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ',
                        í•™êµì¢…ë¥˜: school.SCHUL_KND_SC_NM,
                        ì§€ì—­: school.LCTN_SC_NM,
                        êµìœ¡ì²­ì½”ë“œ: school.ATPT_OFCDC_SC_CODE,
                        í•™êµì½”ë“œ: school.SD_SCHUL_CODE
                    }));
                    
                    showResponse(responseArea, `âœ… ì„±ê³µ! ${result.schools.length}ê°œ í•™êµ ê²€ìƒ‰ ì™„ë£Œ\n\n${JSON.stringify(detailedResults, null, 2)}`, 'success');
                } else {
                    showResponse(responseArea, `âŒ ì˜¤ë¥˜!\n\n${JSON.stringify(result, null, 2)}`, 'error');
                }
                
            } catch (error) {
                showResponse(responseArea, `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜!\n\n${error.message}`, 'error');
            }
        }
        
        // í•™êµ ê²€ìƒ‰ í¼ ì´ˆê¸°í™”
        function clearSchoolSearchForm() {
            document.getElementById('school-name-search').value = '';
            document.getElementById('school-search-limit').value = '10';
            
            const responseArea = document.getElementById('school-search-response');
            responseArea.style.display = 'none';
        }
    </script>
</body>
</html>

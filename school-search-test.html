<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè´ ÌïôÍµê Í≤ÄÏÉâ API ÌÖåÏä§Ìä∏</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .title {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .test-section {
            background: white;
            margin-bottom: 30px;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            color: #2c3e50;
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
        }
        
        .required {
            color: #e74c3c;
        }
        
        .input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }
        
        .input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .btn {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover:not(:disabled) {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #95a5a6;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #7f8c8d;
        }
        
        .search-container {
            position: relative;
        }
        
        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f1f2f6;
            transition: background-color 0.2s ease;
        }
        
        .suggestion-item:hover {
            background-color: #e3f2fd;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .school-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .school-info {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .selected-school {
            background: #e8f6f3;
            border: 1px solid #a3e4d7;
            border-radius: 8px;
            padding: 16px;
            margin-top: 15px;
        }
        
        .selected-school h4 {
            color: #27ae60;
            margin: 0 0 8px 0;
            font-size: 16px;
        }
        
        .selected-school p {
            margin: 4px 0;
            font-size: 14px;
            color: #2c3e50;
        }
        
        .response-area {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .success {
            border-left: 4px solid #4CAF50;
            background-color: #f1f8e9;
        }
        
        .error {
            border-left: 4px solid #f44336;
            background-color: #ffebee;
        }
        
        .loading {
            color: #666;
            font-style: italic;
        }
        
        .hint {
            margin-top: 6px;
            font-size: 12px;
            color: #95a5a6;
            line-height: 1.4;
        }
        
        .step-indicator {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .step {
            flex: 1;
            padding: 8px 12px;
            text-align: center;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            background: #ecf0f1;
            color: #7f8c8d;
        }
        
        .step.active {
            background: #3498db;
            color: white;
        }
        
        .step.completed {
            background: #27ae60;
            color: white;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .weather-card {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            color: white;
            box-shadow: 0 4px 15px rgba(116, 185, 255, 0.3);
        }
        
        .weather-card h4 {
            color: white;
            margin: 0 0 15px 0;
            font-size: 18px;
        }
        
        .weather-main {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .weather-icon {
            font-size: 48px;
            line-height: 1;
        }
        
        .weather-temp {
            font-size: 36px;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }
        
        .weather-desc {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 5px;
        }
        
        .weather-location {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .weather-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .weather-detail-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .weather-detail-label {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .weather-detail-value {
            font-weight: bold;
            color: white;
            font-size: 16px;
        }
        
        .weather-alert {
            background: rgba(255, 193, 7, 0.9);
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            font-size: 14px;
            color: #856404;
            backdrop-filter: blur(10px);
        }
        
        .workflow-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            gap: 20px;
        }
        
        .workflow-step {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 200px;
        }
        
        .workflow-step.active {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-color: #28a745;
            color: white;
            transform: scale(1.05);
        }
        
        .workflow-step.completed {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-color: #28a745;
            color: white;
        }
        
        .workflow-step.processing {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            border-color: #ffc107;
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .workflow-step.active .step-number,
        .workflow-step.completed .step-number {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .step-desc {
            font-size: 12px;
            opacity: 0.8;
            line-height: 1.3;
        }
        
        .workflow-arrow {
            font-size: 24px;
            color: #6c757d;
            font-weight: bold;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            font-size: 18px;
            padding: 15px 30px;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üè´ ÌïôÍµê Í≤ÄÏÉâ & ÎÇ†Ïî® Ï°∞Ìöå ÌÖåÏä§Ìä∏</h1>
            <p class="subtitle">
                ÍµêÏú°Î∂Ä ÎÇòÏù¥Ïä§ APIÎ°ú ÌïôÍµêÎ•º Í≤ÄÏÉâÌïòÍ≥†,<br>
                V-world ÏßÄÏò§ÏΩîÎî© + Í∏∞ÏÉÅÏ≤≠ APIÎ°ú Ìï¥Îãπ ÏßÄÏó≠Ïùò ÎÇ†Ïî®Î•º Ï°∞ÌöåÌï©ÎãàÎã§.<br>
                <small style="color: #27ae60;">‚úÖ Ï£ºÏÜå Ï†ÑÏ≤òÎ¶¨: Ïãú/Íµ∞/Íµ¨Î∂ÄÌÑ∞Îßå APIÏóê Ï†ÑÏÜ°ÌïòÏó¨ Ï†ïÌôïÎèÑ Ìñ•ÏÉÅ</small><br>
                <small style="color: #e74c3c;">‚ö†Ô∏è V-world API ÌÇ§ ÏÑ§Ï†ïÏù¥ ÌïÑÏöîÌïòÍ±∞ÎÇò, ÌòÑÏû¨Îäî ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞Î°ú ÎèôÏûëÌï©ÎãàÎã§.</small>
            </p>
        </div>

        <!-- ÌïôÍµê Í≤ÄÏÉâ ÏÑπÏÖò -->
        <div class="test-section">
            <h2 class="section-title">üîç ÌïôÍµê Í≤ÄÏÉâ (ÏûêÎèôÏôÑÏÑ±)</h2>
            
            <div class="form-group">
                <label for="autocomplete-search" class="label">
                    ÌïôÍµêÎ™Ö Í≤ÄÏÉâ <span class="required">*</span>
                </label>
                <div class="search-container">
                    <input
                        id="autocomplete-search"
                        type="text"
                        class="input"
                        placeholder="ÌïôÍµêÎ™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: ÏÑúÏö∏Ï¥àÎì±ÌïôÍµê)"
                        autocomplete="off"
                    />
                    <div id="autocomplete-suggestions" class="suggestions" style="display: none;"></div>
                </div>
                <div class="hint">
                    2Í∏ÄÏûê Ïù¥ÏÉÅ ÏûÖÎ†•ÌïòÎ©¥ ÏûêÎèôÏúºÎ°ú Í≤ÄÏÉâÎê©ÎãàÎã§.
                </div>
            </div>
            
            <div id="selected-school-info" class="selected-school" style="display: none;">
                <h4>ÏÑ†ÌÉùÎêú ÌïôÍµê</h4>
                <p id="selected-school-name"></p>
                <p id="selected-school-address"></p>
                <p id="selected-school-type"></p>
                <p id="selected-school-location"></p>
            </div>
            
            <button onclick="clearSearch()" class="btn btn-secondary">Ï¥àÍ∏∞Ìôî</button>
            
            <div id="search-response" class="response-area"></div>
        </div>

        <!-- ÏúÑÏπò & ÎÇ†Ïî® Ï†ïÎ≥¥ ÏÑπÏÖò -->
        <div class="test-section">
            <h2 class="section-title">ÔøΩÔ∏è ÏúÑÏπò Ï†ïÎ≥¥ & ÎÇ†Ïî® Ï°∞Ìöå</h2>
            
            <div class="form-group">
                <button onclick="getLocationFromAddress()" class="btn" id="get-location-btn" disabled>
                    üìç ÏúÑÎèÑ/Í≤ΩÎèÑ Ï°∞Ìöå
                </button>
                <button onclick="getWeatherFromLocation()" class="btn" id="get-weather-btn" disabled>
                    üå§Ô∏è ÎÇ†Ïî® Ï†ïÎ≥¥ Ï°∞Ìöå
                </button>
                <div class="hint">
                    Î®ºÏ†Ä ÌïôÍµêÎ•º ÏÑ†ÌÉùÌïú ÌõÑ ÏúÑÏπò Ï†ïÎ≥¥Î•º Ï°∞ÌöåÌïòÍ≥†, ÎÇ†Ïî®Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.
                </div>
            </div>
            
            <!-- ÏúÑÏπò Ï†ïÎ≥¥ ÌëúÏãú -->
            <div id="location-info" class="selected-school" style="display: none;">
                <h4>üìç ÏúÑÏπò Ï†ïÎ≥¥</h4>
                <p id="location-address"></p>
                <p id="location-coords"></p>
                <p id="location-grid"></p>
            </div>
            
            <!-- ÎÇ†Ïî® Ï†ïÎ≥¥ ÌëúÏãú -->
            <div id="weather-info" class="weather-card" style="display: none;">
                <h4>üå§Ô∏è ÌòÑÏû¨ ÎÇ†Ïî®</h4>
                <div class="weather-main">
                    <div class="weather-icon" id="weather-icon">üå§Ô∏è</div>
                    <div>
                        <div class="weather-temp" id="weather-temp">--¬∞C</div>
                        <div class="weather-desc" id="weather-desc">--</div>
                        <div class="weather-location" id="weather-location">üìç --</div>
                    </div>
                </div>
                
                <div class="weather-details">
                    <div class="weather-detail-item">
                        <div class="weather-detail-label">Ï≤¥Í∞êÏò®ÎèÑ</div>
                        <div class="weather-detail-value" id="weather-feels-like">--¬∞C</div>
                    </div>
                    <div class="weather-detail-item">
                        <div class="weather-detail-label">ÏäµÎèÑ</div>
                        <div class="weather-detail-value" id="weather-humidity">--%</div>
                    </div>
                    <div class="weather-detail-item">
                        <div class="weather-detail-label">ÌíçÏÜç</div>
                        <div class="weather-detail-value" id="weather-wind">--m/s</div>
                    </div>
                    <div class="weather-detail-item">
                        <div class="weather-detail-label">Í∞ïÏàòÌôïÎ•†</div>
                        <div class="weather-detail-value" id="weather-rain">--%</div>
                    </div>
                </div>
                
                <div id="weather-alert" class="weather-alert" style="display: none;">
                    ‚ö†Ô∏è <span id="weather-alert-text"></span>
                </div>
            </div>
            
            <div id="location-weather-response" class="response-area"></div>
        </div>

        <!-- ÌÜµÌï© ÌÖåÏä§Ìä∏ ÏÑπÏÖò -->
        <div class="test-section">
            <h2 class="section-title">üöÄ Ï†ÑÏ≤¥ ÌîÑÎ°úÏÑ∏Ïä§ ÌÖåÏä§Ìä∏</h2>
            
            <div class="workflow-steps">
                <div class="workflow-step" id="workflow-step-1">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <div class="step-title">ÌïôÍµê Í≤ÄÏÉâ</div>
                        <div class="step-desc">ÍµêÏú°Î∂Ä APIÎ°ú ÌïôÍµê Ï†ïÎ≥¥ Ï°∞Ìöå</div>
                    </div>
                </div>
                <div class="workflow-arrow">‚Üí</div>
                <div class="workflow-step" id="workflow-step-2">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <div class="step-title">ÏúÑÏπò Î≥ÄÌôò</div>
                        <div class="step-desc">Ï£ºÏÜå ‚Üí ÏúÑÎèÑ/Í≤ΩÎèÑ ‚Üí Í∏∞ÏÉÅÏ≤≠ Í≤©Ïûê</div>
                    </div>
                </div>
                <div class="workflow-arrow">‚Üí</div>
                <div class="workflow-step" id="workflow-step-3">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <div class="step-title">ÎÇ†Ïî® Ï°∞Ìöå</div>
                        <div class="step-desc">Í∏∞ÏÉÅÏ≤≠ APIÎ°ú ÌòÑÏû¨ ÎÇ†Ïî® ÌôïÏù∏</div>
                    </div>
                </div>
            </div>
            
            <button onclick="runFullWorkflow()" class="btn btn-primary" id="full-workflow-btn" disabled>
                ‚ö° Ï†ÑÏ≤¥ ÌîÑÎ°úÏÑ∏Ïä§ Ïã§Ìñâ (ÌïôÍµê ‚Üí ÏúÑÏπò ‚Üí ÎÇ†Ïî®)
            </button>
            
            <div id="workflow-response" class="response-area"></div>
        </div>
    </div>

    <script>
        // ÏÑ§Ï†ï
        const SUPABASE_URL = 'https://unjxokjoytbwkqmqidni.supabase.co';
        
        // ÏÉÅÌÉú Î≥ÄÏàòÎì§
        let autocompleteTimeout;
        let selectedSchoolData = null;
        let currentLocationData = null;
        let currentWeatherData = null;
        
        // ÏùëÎãµ ÌëúÏãú Ìï®Ïàò
        function showResponse(element, message, type) {
            const timestamp = new Date().toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            const messageWithTimestamp = `[${timestamp}] ${message}`;
            element.textContent = messageWithTimestamp;
            element.style.display = 'block';
            element.className = `response-area ${type}`;
        }
        
        // === ÌïôÍµê Í≤ÄÏÉâ (ÏûêÎèôÏôÑÏÑ±) ===
        
        // ÏûêÎèôÏôÑÏÑ± Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            const autocompleteInput = document.getElementById('autocomplete-search');
            autocompleteInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                
                // Í∏∞Ï°¥ ÌÉÄÏù¥Î®∏ ÌÅ¥Î¶¨Ïñ¥
                clearTimeout(autocompleteTimeout);
                
                if (query.length >= 2) {
                    // 500ms ÎîúÎ†àÏù¥ ÌõÑ Í≤ÄÏÉâ
                    autocompleteTimeout = setTimeout(() => {
                        searchSchoolsAutocomplete(query);
                    }, 500);
                } else {
                    hideSuggestions();
                }
            });
            
            // ÌÅ¥Î¶≠ Ïô∏Î∂Ä ÏòÅÏó≠ÏóêÏÑú ÏûêÎèôÏôÑÏÑ± Ïà®Í∏∞Í∏∞
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    hideSuggestions();
                }
            });
        });
        
        // ÏûêÎèôÏôÑÏÑ± Í≤ÄÏÉâ
        async function searchSchoolsAutocomplete(query) {
            const responseArea = document.getElementById('search-response');
            showResponse(responseArea, `"${query}" Í≤ÄÏÉâ Ï§ë...`, 'loading');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/search-schools`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        schoolName: query,
                        limit: 10
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResponse(responseArea, `‚úÖ ${result.schools.length}Í∞ú ÌïôÍµê Í≤ÄÏÉâ ÏôÑÎ£å`, 'success');
                    displayAutocompleteSuggestions(result.schools);
                } else {
                    showResponse(responseArea, `‚ùå Í≤ÄÏÉâ Ïã§Ìå®!\n\n${JSON.stringify(result, null, 2)}`, 'error');
                    hideSuggestions();
                }
                
            } catch (error) {
                showResponse(responseArea, `‚ùå ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò!\n\n${error.message}`, 'error');
                hideSuggestions();
            }
        }
        
        // ÏûêÎèôÏôÑÏÑ± Ï†úÏïà ÌëúÏãú
        function displayAutocompleteSuggestions(schools) {
            const suggestionsContainer = document.getElementById('autocomplete-suggestions');
            
            if (schools.length === 0) {
                hideSuggestions();
                return;
            }
            
            suggestionsContainer.innerHTML = '';
            
            schools.forEach(school => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                suggestionItem.innerHTML = `
                    <div class="school-name">${school.SCHUL_NM}</div>
                    <div class="school-info">
                        ${school.SCHUL_KND_SC_NM} | ${school.LCTN_SC_NM} | ${school.ORG_RDNMA || 'Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùå'}
                    </div>
                `;
                
                suggestionItem.addEventListener('click', () => {
                    selectSchool(school);
                });
                
                suggestionsContainer.appendChild(suggestionItem);
            });
            
            suggestionsContainer.style.display = 'block';
        }
        
        // ÌïôÍµê ÏÑ†ÌÉù
        function selectSchool(school) {
            document.getElementById('autocomplete-search').value = school.SCHUL_NM;
            hideSuggestions();
            showSelectedSchool(school);
            selectedSchoolData = school;
            
            // Î≤ÑÌäº ÌôúÏÑ±Ìôî
            document.getElementById('get-location-btn').disabled = false;
            document.getElementById('full-workflow-btn').disabled = false;
            
            // ÏõåÌÅ¨ÌîåÎ°úÏö∞ Îã®Í≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            updateWorkflowStep(1, 'completed');
            updateWorkflowStep(2, 'active');
        }
        
        // ÏûêÎèôÏôÑÏÑ± Ï†úÏïà Ïà®Í∏∞Í∏∞
        function hideSuggestions() {
            document.getElementById('autocomplete-suggestions').style.display = 'none';
        }
        
        // ÏÑ†ÌÉùÎêú ÌïôÍµê Ï†ïÎ≥¥ ÌëúÏãú
        function showSelectedSchool(school) {
            const container = document.getElementById('selected-school-info');
            
            document.getElementById('selected-school-name').textContent = `üè´ ${school.SCHUL_NM}`;
            document.getElementById('selected-school-address').textContent = `üìç ${school.ORG_RDNMA || 'Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùå'}`;
            document.getElementById('selected-school-type').textContent = `üéì ${school.SCHUL_KND_SC_NM}`;
            document.getElementById('selected-school-location').textContent = `üó∫Ô∏è ${school.LCTN_SC_NM} (ÏΩîÎìú: ${school.ATPT_OFCDC_SC_CODE})`;
            
            container.style.display = 'block';
        }
        
        // Í≤ÄÏÉâ Ï¥àÍ∏∞Ìôî
        function clearSearch() {
            document.getElementById('autocomplete-search').value = '';
            hideSuggestions();
            document.getElementById('selected-school-info').style.display = 'none';
            document.getElementById('location-info').style.display = 'none';
            document.getElementById('weather-info').style.display = 'none';
            
            // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            selectedSchoolData = null;
            currentLocationData = null;
            currentWeatherData = null;
            
            // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            document.getElementById('get-location-btn').disabled = true;
            document.getElementById('get-weather-btn').disabled = true;
            document.getElementById('full-workflow-btn').disabled = true;
            
            // ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ï¥àÍ∏∞Ìôî
            resetWorkflow();
            
            const responseArea = document.getElementById('search-response');
            responseArea.style.display = 'none';
        }
        
        // === ÏúÑÏπò Ï†ïÎ≥¥ Ï°∞Ìöå ===
        
        // Ï£ºÏÜåÏóêÏÑú ÏúÑÎèÑ/Í≤ΩÎèÑ Ï°∞Ìöå
        async function getLocationFromAddress() {
            if (!selectedSchoolData?.ORG_RDNMA) {
                alert('Î®ºÏ†Ä ÌïôÍµêÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            const responseArea = document.getElementById('location-weather-response');
            showResponse(responseArea, 'Ï£ºÏÜåÎ•º ÏúÑÎèÑ/Í≤ΩÎèÑÎ°ú Î≥ÄÌôò Ï§ë...', 'loading');
            updateWorkflowStep(2, 'processing');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/geocode-address`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        address: selectedSchoolData.ORG_RDNMA
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResponse(responseArea, `‚úÖ ÏúÑÏπò Ï†ïÎ≥¥ Ï°∞Ìöå ÏôÑÎ£å!`, 'success');
                    displayLocationInfo(result.location);
                    currentLocationData = result.location;
                    
                    // ÎÇ†Ïî® Î≤ÑÌäº ÌôúÏÑ±Ìôî
                    document.getElementById('get-weather-btn').disabled = false;
                    
                    // ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÏóÖÎç∞Ïù¥Ìä∏
                    updateWorkflowStep(2, 'completed');
                    updateWorkflowStep(3, 'active');
                } else {
                    showResponse(responseArea, `‚ùå ÏúÑÏπò Ï°∞Ìöå Ïã§Ìå®!\n\n${JSON.stringify(result, null, 2)}`, 'error');
                    updateWorkflowStep(2, 'active');
                }
                
            } catch (error) {
                showResponse(responseArea, `‚ùå ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò!\n\n${error.message}`, 'error');
                updateWorkflowStep(2, 'active');
            }
        }
        
        // ÏúÑÏπò Ï†ïÎ≥¥ ÌëúÏãú
        function displayLocationInfo(location) {
            const container = document.getElementById('location-info');
            
            document.getElementById('location-address').textContent = `üìç Ï£ºÏÜå: ${location.address}`;
            document.getElementById('location-coords').textContent = `üåç Ï¢åÌëú: ${location.latitude}, ${location.longitude}`;
            document.getElementById('location-grid').textContent = `üìê Í∏∞ÏÉÅÏ≤≠ Í≤©Ïûê: nx=${location.gridX}, ny=${location.gridY}`;
            
            container.style.display = 'block';
        }
        
        // === ÎÇ†Ïî® Ï†ïÎ≥¥ Ï°∞Ìöå ===
        
        // ÏúÑÏπò Í∏∞Î∞ò ÎÇ†Ïî® Ï°∞Ìöå
        async function getWeatherFromLocation() {
            if (!currentLocationData?.gridX || !currentLocationData?.gridY) {
                alert('Î®ºÏ†Ä ÏúÑÏπò Ï†ïÎ≥¥Î•º Ï°∞ÌöåÌï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            const responseArea = document.getElementById('location-weather-response');
            showResponse(responseArea, 'ÎÇ†Ïî® Ï†ïÎ≥¥Î•º Ï°∞Ìöå Ï§ë...', 'loading');
            updateWorkflowStep(3, 'processing');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/get-weather-by-grid`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lat: currentLocationData.latitude,
                        lng: currentLocationData.longitude,
                        address: selectedSchoolData.SCHUL_NM
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResponse(responseArea, `‚úÖ ÎÇ†Ïî® Ï†ïÎ≥¥ Ï°∞Ìöå ÏôÑÎ£å!`, 'success');
                    displayWeatherInfo(result.weather);
                    currentWeatherData = result.weather;
                    
                    // ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÏôÑÎ£å
                    updateWorkflowStep(3, 'completed');
                } else {
                    showResponse(responseArea, `‚ùå ÎÇ†Ïî® Ï°∞Ìöå Ïã§Ìå®!\n\n${JSON.stringify(result, null, 2)}`, 'error');
                    updateWorkflowStep(3, 'active');
                }
                
            } catch (error) {
                showResponse(responseArea, `‚ùå ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò!\n\n${error.message}`, 'error');
                updateWorkflowStep(3, 'active');
            }
        }
        
        // ÎÇ†Ïî® Ï†ïÎ≥¥ ÌëúÏãú
        function displayWeatherInfo(weather) {
            const container = document.getElementById('weather-info');
            
            // ÎÇ†Ïî® ÏïÑÏù¥ÏΩò Îß§Ìïë
            const getWeatherIcon = (condition) => {
                const iconMap = {
                    'ÎßëÏùå': '‚òÄÔ∏è',
                    'Íµ¨Î¶ÑÎßéÏùå': '‚õÖ',
                    'ÌùêÎ¶º': '‚òÅÔ∏è',
                    'ÎπÑ': 'üåßÔ∏è',
                    'Îàà': '‚ùÑÔ∏è',
                    'ÎáåÏö∞': '‚õàÔ∏è',
                    'ÏïàÍ∞ú': 'üå´Ô∏è'
                };
                return iconMap[condition] || 'üå§Ô∏è';
            };
            
            document.getElementById('weather-icon').textContent = getWeatherIcon(weather.condition);
            document.getElementById('weather-temp').textContent = `${weather.temperature}¬∞C`;
            document.getElementById('weather-desc').textContent = weather.condition;
            document.getElementById('weather-location').textContent = `üìç ${weather.location}`;
            document.getElementById('weather-feels-like').textContent = `${weather.feelsLike || weather.temperature}¬∞C`;
            document.getElementById('weather-humidity').textContent = `${weather.humidity || 'N/A'}%`;
            document.getElementById('weather-wind').textContent = `${weather.windSpeed || 'N/A'}m/s`;
            document.getElementById('weather-rain').textContent = `${weather.rainProbability || 'N/A'}%`;
            
            // Í∏∞ÏÉÅÌäπÎ≥¥ ÌëúÏãú
            if (weather.alerts) {
                document.getElementById('weather-alert-text').textContent = weather.alerts;
                document.getElementById('weather-alert').style.display = 'block';
            } else {
                document.getElementById('weather-alert').style.display = 'none';
            }
            
            container.style.display = 'block';
        }
        
        // === ÏõåÌÅ¨ÌîåÎ°úÏö∞ Í¥ÄÎ¶¨ ===
        
        // ÏõåÌÅ¨ÌîåÎ°úÏö∞ Îã®Í≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateWorkflowStep(stepNumber, status) {
            const step = document.getElementById(`workflow-step-${stepNumber}`);
            step.className = `workflow-step ${status}`;
        }
        
        // ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ï¥àÍ∏∞Ìôî
        function resetWorkflow() {
            updateWorkflowStep(1, 'active');
            updateWorkflowStep(2, '');
            updateWorkflowStep(3, '');
        }
        
        // === Ï†ÑÏ≤¥ ÌîÑÎ°úÏÑ∏Ïä§ Ïã§Ìñâ ===
        
        // Ï†ÑÏ≤¥ ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ïã§Ìñâ (ÌïôÍµê ‚Üí ÏúÑÏπò ‚Üí ÎÇ†Ïî®)
        async function runFullWorkflow() {
            if (!selectedSchoolData) {
                alert('Î®ºÏ†Ä ÌïôÍµêÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            const responseArea = document.getElementById('workflow-response');
            showResponse(responseArea, 'Ï†ÑÏ≤¥ ÌîÑÎ°úÏÑ∏Ïä§Î•º Ïã§ÌñâÌï©ÎãàÎã§...', 'loading');
            
            try {
                // 1Îã®Í≥Ñ: ÏúÑÏπò Ï†ïÎ≥¥ Ï°∞Ìöå
                updateWorkflowStep(2, 'processing');
                await new Promise(resolve => setTimeout(resolve, 500)); // UI ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏúÑÌïú ÎîúÎ†àÏù¥
                
                const locationResponse = await fetch(`${SUPABASE_URL}/functions/v1/geocode-address`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        address: selectedSchoolData.ORG_RDNMA
                    })
                });

                const locationResult = await locationResponse.json();
                
                if (!locationResponse.ok || !locationResult.success) {
                    throw new Error('ÏúÑÏπò Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®');
                }
                
                currentLocationData = locationResult.location;
                displayLocationInfo(currentLocationData);
                updateWorkflowStep(2, 'completed');
                
                // 2Îã®Í≥Ñ: ÎÇ†Ïî® Ï†ïÎ≥¥ Ï°∞Ìöå
                updateWorkflowStep(3, 'processing');
                await new Promise(resolve => setTimeout(resolve, 500)); // UI ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏúÑÌïú ÎîúÎ†àÏù¥
                
                const weatherResponse = await fetch(`${SUPABASE_URL}/functions/v1/get-weather-by-grid`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lat: currentLocationData.latitude,
                        lng: currentLocationData.longitude,
                        address: selectedSchoolData.SCHUL_NM
                    })
                });

                const weatherResult = await weatherResponse.json();
                
                if (!weatherResponse.ok || !weatherResult.success) {
                    throw new Error('ÎÇ†Ïî® Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®');
                }
                
                currentWeatherData = weatherResult.weather;
                displayWeatherInfo(currentWeatherData);
                updateWorkflowStep(3, 'completed');
                
                // Î™®Îì† Î≤ÑÌäº ÌôúÏÑ±Ìôî
                document.getElementById('get-location-btn').disabled = false;
                document.getElementById('get-weather-btn').disabled = false;
                
                showResponse(responseArea, '‚úÖ Ï†ÑÏ≤¥ ÌîÑÎ°úÏÑ∏Ïä§ ÏôÑÎ£å!\nÌïôÍµê ‚Üí ÏúÑÏπò ‚Üí ÎÇ†Ïî® Ï†ïÎ≥¥Î•º Î™®Îëê Ï°∞ÌöåÌñàÏäµÎãàÎã§.', 'success');
                
            } catch (error) {
                showResponse(responseArea, `‚ùå ÌîÑÎ°úÏÑ∏Ïä§ Ïã§Ìñâ Ï§ë Ïò§Î•ò!\n\n${error.message}`, 'error');
                console.error('Full workflow error:', error);
            }
        }
    </script>
</body>
</html>

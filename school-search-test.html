<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ« í•™êµ ê²€ìƒ‰ API í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .title {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .test-section {
            background: white;
            margin-bottom: 30px;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            color: #2c3e50;
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
        }
        
        .required {
            color: #e74c3c;
        }
        
        .input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }
        
        .input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .btn {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover:not(:disabled) {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #95a5a6;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #7f8c8d;
        }
        
        .search-container {
            position: relative;
        }
        
        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f1f2f6;
            transition: background-color 0.2s ease;
        }
        
        .suggestion-item:hover {
            background-color: #e3f2fd;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .school-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .school-info {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .selected-school {
            background: #e8f6f3;
            border: 1px solid #a3e4d7;
            border-radius: 8px;
            padding: 16px;
            margin-top: 15px;
        }
        
        .selected-school h4 {
            color: #27ae60;
            margin: 0 0 8px 0;
            font-size: 16px;
        }
        
        .selected-school p {
            margin: 4px 0;
            font-size: 14px;
            color: #2c3e50;
        }
        
        .response-area {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .success {
            border-left: 4px solid #4CAF50;
            background-color: #f1f8e9;
        }
        
        .error {
            border-left: 4px solid #f44336;
            background-color: #ffebee;
        }
        
        .loading {
            color: #666;
            font-style: italic;
        }
        
        .hint {
            margin-top: 6px;
            font-size: 12px;
            color: #95a5a6;
            line-height: 1.4;
        }
        
        .step-indicator {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .step {
            flex: 1;
            padding: 8px 12px;
            text-align: center;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            background: #ecf0f1;
            color: #7f8c8d;
        }
        
        .step.active {
            background: #3498db;
            color: white;
        }
        
        .step.completed {
            background: #27ae60;
            color: white;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .weather-card {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            color: white;
            box-shadow: 0 4px 15px rgba(116, 185, 255, 0.3);
        }
        
        .weather-card h4 {
            color: white;
            margin: 0 0 15px 0;
            font-size: 18px;
        }
        
        .weather-main {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .weather-icon {
            font-size: 48px;
            line-height: 1;
        }
        
        .weather-temp {
            font-size: 36px;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }
        
        .weather-desc {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 5px;
        }
        
        .weather-location {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .weather-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .weather-detail-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .weather-detail-label {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .weather-detail-value {
            font-weight: bold;
            color: white;
            font-size: 16px;
        }
        
        .weather-alert {
            background: rgba(255, 193, 7, 0.9);
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            font-size: 14px;
            color: #856404;
            backdrop-filter: blur(10px);
        }
        
        .workflow-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            gap: 20px;
        }
        
        .workflow-step {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 200px;
        }
        
        .workflow-step.active {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-color: #28a745;
            color: white;
            transform: scale(1.05);
        }
        
        .workflow-step.completed {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-color: #28a745;
            color: white;
        }
        
        .workflow-step.processing {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            border-color: #ffc107;
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .workflow-step.active .step-number,
        .workflow-step.completed .step-number {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .step-desc {
            font-size: 12px;
            opacity: 0.8;
            line-height: 1.3;
        }
        
        .workflow-arrow {
            font-size: 24px;
            color: #6c757d;
            font-weight: bold;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            font-size: 18px;
            padding: 15px 30px;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">ğŸ« í•™êµ ê²€ìƒ‰ & ë‚ ì”¨ ì¡°íšŒ í…ŒìŠ¤íŠ¸</h1>
            <p class="subtitle">
                êµìœ¡ë¶€ ë‚˜ì´ìŠ¤ APIë¡œ í•™êµë¥¼ ê²€ìƒ‰í•˜ê³ ,<br>
                V-world ì§€ì˜¤ì½”ë”© + ê¸°ìƒì²­ APIë¡œ í•´ë‹¹ ì§€ì—­ì˜ ë‚ ì”¨ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.<br>
                <small style="color: #27ae60;">âœ… ì£¼ì†Œ ì „ì²˜ë¦¬: ì‹œ/êµ°/êµ¬ë¶€í„°ë§Œ APIì— ì „ì†¡í•˜ì—¬ ì •í™•ë„ í–¥ìƒ</small><br>
                <small style="color: #e74c3c;">âš ï¸ V-world API í‚¤ ì„¤ì •ì´ í•„ìš”í•˜ê±°ë‚˜, í˜„ì¬ëŠ” ë”ë¯¸ ë°ì´í„°ë¡œ ë™ì‘í•©ë‹ˆë‹¤.</small>
            </p>
        </div>

        <!-- í•™êµ ê²€ìƒ‰ ì„¹ì…˜ -->
        <div class="test-section">
            <h2 class="section-title">ğŸ” í•™êµ ê²€ìƒ‰ (ìë™ì™„ì„±)</h2>
            
            <div class="form-group">
                <label for="autocomplete-search" class="label">
                    í•™êµëª… ê²€ìƒ‰ <span class="required">*</span>
                </label>
                <div class="search-container">
                    <input
                        id="autocomplete-search"
                        type="text"
                        class="input"
                        placeholder="í•™êµëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì„œìš¸ì´ˆë“±í•™êµ)"
                        autocomplete="off"
                    />
                    <div id="autocomplete-suggestions" class="suggestions" style="display: none;"></div>
                </div>
                <div class="hint">
                    2ê¸€ì ì´ìƒ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ê²€ìƒ‰ë©ë‹ˆë‹¤.
                </div>
            </div>
            
            <div id="selected-school-info" class="selected-school" style="display: none;">
                <h4>ì„ íƒëœ í•™êµ</h4>
                <p id="selected-school-name"></p>
                <p id="selected-school-address"></p>
                <p id="selected-school-type"></p>
                <p id="selected-school-location"></p>
            </div>
            
            <button onclick="clearSearch()" class="btn btn-secondary">ì´ˆê¸°í™”</button>
            
            <div id="search-response" class="response-area"></div>
        </div>

        <!-- ìœ„ì¹˜ & ë‚ ì”¨ ì •ë³´ ì„¹ì…˜ -->
        <div class="test-section">
            <h2 class="section-title">ï¿½ï¸ ìœ„ì¹˜ ì •ë³´ & ë‚ ì”¨ ì¡°íšŒ</h2>
            
            <div class="form-group">
                <button onclick="getLocationFromAddress()" class="btn" id="get-location-btn" disabled>
                    ğŸ“ ìœ„ë„/ê²½ë„ ì¡°íšŒ
                </button>
                <button onclick="getWeatherFromLocation()" class="btn" id="get-weather-btn" disabled>
                    ğŸŒ¤ï¸ ë‚ ì”¨ ì •ë³´ ì¡°íšŒ
                </button>
                <div class="hint">
                    ë¨¼ì € í•™êµë¥¼ ì„ íƒí•œ í›„ ìœ„ì¹˜ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³ , ë‚ ì”¨ë¥¼ í™•ì¸í•˜ì„¸ìš”.
                </div>
            </div>
            
            <!-- ìœ„ì¹˜ ì •ë³´ í‘œì‹œ -->
            <div id="location-info" class="selected-school" style="display: none;">
                <h4>ğŸ“ ìœ„ì¹˜ ì •ë³´</h4>
                <p id="location-address"></p>
                <p id="location-coords"></p>
                <p id="location-grid"></p>
            </div>
            
            <!-- ë‚ ì”¨ ì •ë³´ í‘œì‹œ -->
            <div id="weather-info" class="weather-card" style="display: none;">
                <h4>ğŸŒ¤ï¸ í˜„ì¬ ë‚ ì”¨</h4>
                <div class="weather-main">
                    <div class="weather-icon" id="weather-icon">ğŸŒ¤ï¸</div>
                    <div>
                        <div class="weather-temp" id="weather-temp">--Â°C</div>
                        <div class="weather-desc" id="weather-desc">--</div>
                        <div class="weather-location" id="weather-location">ğŸ“ --</div>
                    </div>
                </div>
                
                <div class="weather-details">
                    <div class="weather-detail-item">
                        <div class="weather-detail-label">ì²´ê°ì˜¨ë„</div>
                        <div class="weather-detail-value" id="weather-feels-like">--Â°C</div>
                    </div>
                    <div class="weather-detail-item">
                        <div class="weather-detail-label">ìŠµë„</div>
                        <div class="weather-detail-value" id="weather-humidity">--%</div>
                    </div>
                    <div class="weather-detail-item">
                        <div class="weather-detail-label">í’ì†</div>
                        <div class="weather-detail-value" id="weather-wind">--m/s</div>
                    </div>
                    <div class="weather-detail-item">
                        <div class="weather-detail-label">ê°•ìˆ˜í™•ë¥ </div>
                        <div class="weather-detail-value" id="weather-rain">--%</div>
                    </div>
                </div>
                
                <div id="weather-alert" class="weather-alert" style="display: none;">
                    âš ï¸ <span id="weather-alert-text"></span>
                </div>
            </div>
            
            <div id="location-weather-response" class="response-area"></div>
        </div>

        <!-- í†µí•© í…ŒìŠ¤íŠ¸ ì„¹ì…˜ -->
        <div class="test-section">
            <h2 class="section-title">ğŸš€ ì „ì²´ í”„ë¡œì„¸ìŠ¤ í…ŒìŠ¤íŠ¸</h2>
            
            <div class="workflow-steps">
                <div class="workflow-step" id="workflow-step-1">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <div class="step-title">í•™êµ ê²€ìƒ‰</div>
                        <div class="step-desc">êµìœ¡ë¶€ APIë¡œ í•™êµ ì •ë³´ ì¡°íšŒ</div>
                    </div>
                </div>
                <div class="workflow-arrow">â†’</div>
                <div class="workflow-step" id="workflow-step-2">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <div class="step-title">ìœ„ì¹˜ ë³€í™˜</div>
                        <div class="step-desc">ì£¼ì†Œ â†’ ìœ„ë„/ê²½ë„ â†’ ê¸°ìƒì²­ ê²©ì</div>
                    </div>
                </div>
                <div class="workflow-arrow">â†’</div>
                <div class="workflow-step" id="workflow-step-3">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <div class="step-title">ë‚ ì”¨ ì¡°íšŒ</div>
                        <div class="step-desc">ê¸°ìƒì²­ APIë¡œ í˜„ì¬ ë‚ ì”¨ í™•ì¸</div>
                    </div>
                </div>
            </div>
            
            <button onclick="runFullWorkflow()" class="btn btn-primary" id="full-workflow-btn" disabled>
                âš¡ ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ (í•™êµ â†’ ìœ„ì¹˜ â†’ ë‚ ì”¨)
            </button>
            
            <div id="workflow-response" class="response-area"></div>
        </div>
    </div>

    <script>
        // ì„¤ì •
        const SUPABASE_URL = 'https://unjxokjoytbwkqmqidni.supabase.co';
        
        // ìƒíƒœ ë³€ìˆ˜ë“¤
        let autocompleteTimeout;
        let selectedSchoolData = null;
        let currentLocationData = null;
        let currentWeatherData = null;
        
        // ì‘ë‹µ í‘œì‹œ í•¨ìˆ˜
        function showResponse(element, message, type) {
            const timestamp = new Date().toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            const messageWithTimestamp = `[${timestamp}] ${message}`;
            element.textContent = messageWithTimestamp;
            element.style.display = 'block';
            element.className = `response-area ${type}`;
        }
        
        // === í•™êµ ê²€ìƒ‰ (ìë™ì™„ì„±) ===
        
        // ìë™ì™„ì„± ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            const autocompleteInput = document.getElementById('autocomplete-search');
            autocompleteInput.addEventListener('input', function(e) {
                const query = e.target.value.trim();
                
                // ê¸°ì¡´ íƒ€ì´ë¨¸ í´ë¦¬ì–´
                clearTimeout(autocompleteTimeout);
                
                if (query.length >= 2) {
                    // 500ms ë”œë ˆì´ í›„ ê²€ìƒ‰
                    autocompleteTimeout = setTimeout(() => {
                        searchSchoolsAutocomplete(query);
                    }, 500);
                } else {
                    hideSuggestions();
                }
            });
            
            // í´ë¦­ ì™¸ë¶€ ì˜ì—­ì—ì„œ ìë™ì™„ì„± ìˆ¨ê¸°ê¸°
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    hideSuggestions();
                }
            });
        });
        
        // ìë™ì™„ì„± ê²€ìƒ‰
        async function searchSchoolsAutocomplete(query) {
            const responseArea = document.getElementById('search-response');
            showResponse(responseArea, `"${query}" ê²€ìƒ‰ ì¤‘...`, 'loading');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/search-schools`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        schoolName: query,
                        limit: 10
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResponse(responseArea, `âœ… ${result.schools.length}ê°œ í•™êµ ê²€ìƒ‰ ì™„ë£Œ`, 'success');
                    displayAutocompleteSuggestions(result.schools);
                } else {
                    showResponse(responseArea, `âŒ ê²€ìƒ‰ ì‹¤íŒ¨!\n\n${JSON.stringify(result, null, 2)}`, 'error');
                    hideSuggestions();
                }
                
            } catch (error) {
                showResponse(responseArea, `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜!\n\n${error.message}`, 'error');
                hideSuggestions();
            }
        }
        
        // ìë™ì™„ì„± ì œì•ˆ í‘œì‹œ
        function displayAutocompleteSuggestions(schools) {
            const suggestionsContainer = document.getElementById('autocomplete-suggestions');
            
            if (schools.length === 0) {
                hideSuggestions();
                return;
            }
            
            suggestionsContainer.innerHTML = '';
            
            schools.forEach(school => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                suggestionItem.innerHTML = `
                    <div class="school-name">${school.SCHUL_NM}</div>
                    <div class="school-info">
                        ${school.SCHUL_KND_SC_NM} | ${school.LCTN_SC_NM} | ${school.ORG_RDNMA || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}
                    </div>
                `;
                
                suggestionItem.addEventListener('click', () => {
                    selectSchool(school);
                });
                
                suggestionsContainer.appendChild(suggestionItem);
            });
            
            suggestionsContainer.style.display = 'block';
        }
        
        // í•™êµ ì„ íƒ
        function selectSchool(school) {
            document.getElementById('autocomplete-search').value = school.SCHUL_NM;
            hideSuggestions();
            showSelectedSchool(school);
            selectedSchoolData = school;
            
            // ë²„íŠ¼ í™œì„±í™”
            document.getElementById('get-location-btn').disabled = false;
            document.getElementById('full-workflow-btn').disabled = false;
            
            // ì›Œí¬í”Œë¡œìš° ë‹¨ê³„ ì—…ë°ì´íŠ¸
            updateWorkflowStep(1, 'completed');
            updateWorkflowStep(2, 'active');
        }
        
        // ìë™ì™„ì„± ì œì•ˆ ìˆ¨ê¸°ê¸°
        function hideSuggestions() {
            document.getElementById('autocomplete-suggestions').style.display = 'none';
        }
        
        // ì„ íƒëœ í•™êµ ì •ë³´ í‘œì‹œ
        function showSelectedSchool(school) {
            const container = document.getElementById('selected-school-info');
            
            document.getElementById('selected-school-name').textContent = `ğŸ« ${school.SCHUL_NM}`;
            document.getElementById('selected-school-address').textContent = `ğŸ“ ${school.ORG_RDNMA || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}`;
            document.getElementById('selected-school-type').textContent = `ğŸ“ ${school.SCHUL_KND_SC_NM}`;
            document.getElementById('selected-school-location').textContent = `ğŸ—ºï¸ ${school.LCTN_SC_NM} (ì½”ë“œ: ${school.ATPT_OFCDC_SC_CODE})`;
            
            container.style.display = 'block';
        }
        
        // ê²€ìƒ‰ ì´ˆê¸°í™”
        function clearSearch() {
            document.getElementById('autocomplete-search').value = '';
            hideSuggestions();
            document.getElementById('selected-school-info').style.display = 'none';
            document.getElementById('location-info').style.display = 'none';
            document.getElementById('weather-info').style.display = 'none';
            
            // ìƒíƒœ ì´ˆê¸°í™”
            selectedSchoolData = null;
            currentLocationData = null;
            currentWeatherData = null;
            
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            document.getElementById('get-location-btn').disabled = true;
            document.getElementById('get-weather-btn').disabled = true;
            document.getElementById('full-workflow-btn').disabled = true;
            
            // ì›Œí¬í”Œë¡œìš° ì´ˆê¸°í™”
            resetWorkflow();
            
            const responseArea = document.getElementById('search-response');
            responseArea.style.display = 'none';
        }
        
        // === ìœ„ì¹˜ ì •ë³´ ì¡°íšŒ ===
        
        // ì£¼ì†Œì—ì„œ ìœ„ë„/ê²½ë„ ì¡°íšŒ
        async function getLocationFromAddress() {
            if (!selectedSchoolData?.ORG_RDNMA) {
                alert('ë¨¼ì € í•™êµë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const responseArea = document.getElementById('location-weather-response');
            showResponse(responseArea, 'ì£¼ì†Œë¥¼ ìœ„ë„/ê²½ë„ë¡œ ë³€í™˜ ì¤‘...', 'loading');
            updateWorkflowStep(2, 'processing');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/geocode-address`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        address: selectedSchoolData.ORG_RDNMA
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResponse(responseArea, `âœ… ìœ„ì¹˜ ì •ë³´ ì¡°íšŒ ì™„ë£Œ!`, 'success');
                    displayLocationInfo(result.location);
                    currentLocationData = result.location;
                    
                    // ë‚ ì”¨ ë²„íŠ¼ í™œì„±í™”
                    document.getElementById('get-weather-btn').disabled = false;
                    
                    // ì›Œí¬í”Œë¡œìš° ì—…ë°ì´íŠ¸
                    updateWorkflowStep(2, 'completed');
                    updateWorkflowStep(3, 'active');
                } else {
                    showResponse(responseArea, `âŒ ìœ„ì¹˜ ì¡°íšŒ ì‹¤íŒ¨!\n\n${JSON.stringify(result, null, 2)}`, 'error');
                    updateWorkflowStep(2, 'active');
                }
                
            } catch (error) {
                showResponse(responseArea, `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜!\n\n${error.message}`, 'error');
                updateWorkflowStep(2, 'active');
            }
        }
        
        // ìœ„ì¹˜ ì •ë³´ í‘œì‹œ
        function displayLocationInfo(location) {
            const container = document.getElementById('location-info');
            
            document.getElementById('location-address').textContent = `ğŸ“ ì£¼ì†Œ: ${location.address}`;
            document.getElementById('location-coords').textContent = `ğŸŒ ì¢Œí‘œ: ${location.latitude}, ${location.longitude}`;
            document.getElementById('location-grid').textContent = `ğŸ“ ê¸°ìƒì²­ ê²©ì: nx=${location.gridX}, ny=${location.gridY}`;
            
            container.style.display = 'block';
        }
        
        // === ë‚ ì”¨ ì •ë³´ ì¡°íšŒ ===
        
        // ìœ„ì¹˜ ê¸°ë°˜ ë‚ ì”¨ ì¡°íšŒ
        async function getWeatherFromLocation() {
            if (!currentLocationData?.gridX || !currentLocationData?.gridY) {
                alert('ë¨¼ì € ìœ„ì¹˜ ì •ë³´ë¥¼ ì¡°íšŒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const responseArea = document.getElementById('location-weather-response');
            showResponse(responseArea, 'ë‚ ì”¨ ì •ë³´ë¥¼ ì¡°íšŒ ì¤‘...', 'loading');
            updateWorkflowStep(3, 'processing');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/get-weather-by-grid`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lat: currentLocationData.latitude,
                        lng: currentLocationData.longitude,
                        address: selectedSchoolData.SCHUL_NM
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResponse(responseArea, `âœ… ë‚ ì”¨ ì •ë³´ ì¡°íšŒ ì™„ë£Œ!`, 'success');
                    displayWeatherInfo(result.weather);
                    currentWeatherData = result.weather;
                    
                    // ì›Œí¬í”Œë¡œìš° ì™„ë£Œ
                    updateWorkflowStep(3, 'completed');
                } else {
                    showResponse(responseArea, `âŒ ë‚ ì”¨ ì¡°íšŒ ì‹¤íŒ¨!\n\n${JSON.stringify(result, null, 2)}`, 'error');
                    updateWorkflowStep(3, 'active');
                }
                
            } catch (error) {
                showResponse(responseArea, `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜!\n\n${error.message}`, 'error');
                updateWorkflowStep(3, 'active');
            }
        }
        
        // ë‚ ì”¨ ì •ë³´ í‘œì‹œ
        function displayWeatherInfo(weather) {
            const container = document.getElementById('weather-info');
            
            // ë‚ ì”¨ ì•„ì´ì½˜ ë§¤í•‘
            const getWeatherIcon = (condition) => {
                const iconMap = {
                    'ë§‘ìŒ': 'â˜€ï¸',
                    'êµ¬ë¦„ë§ìŒ': 'â›…',
                    'íë¦¼': 'â˜ï¸',
                    'ë¹„': 'ğŸŒ§ï¸',
                    'ëˆˆ': 'â„ï¸',
                    'ë‡Œìš°': 'â›ˆï¸',
                    'ì•ˆê°œ': 'ğŸŒ«ï¸'
                };
                return iconMap[condition] || 'ğŸŒ¤ï¸';
            };
            
            document.getElementById('weather-icon').textContent = getWeatherIcon(weather.condition);
            document.getElementById('weather-temp').textContent = `${weather.temperature}Â°C`;
            document.getElementById('weather-desc').textContent = weather.condition;
            document.getElementById('weather-location').textContent = `ğŸ“ ${weather.location}`;
            document.getElementById('weather-feels-like').textContent = `${weather.feelsLike || weather.temperature}Â°C`;
            document.getElementById('weather-humidity').textContent = `${weather.humidity || 'N/A'}%`;
            document.getElementById('weather-wind').textContent = `${weather.windSpeed || 'N/A'}m/s`;
            document.getElementById('weather-rain').textContent = `${weather.rainProbability || 'N/A'}%`;
            
            // ê¸°ìƒíŠ¹ë³´ í‘œì‹œ
            if (weather.alerts) {
                document.getElementById('weather-alert-text').textContent = weather.alerts;
                document.getElementById('weather-alert').style.display = 'block';
            } else {
                document.getElementById('weather-alert').style.display = 'none';
            }
            
            container.style.display = 'block';
        }
        
        // === ì›Œí¬í”Œë¡œìš° ê´€ë¦¬ ===
        
        // ì›Œí¬í”Œë¡œìš° ë‹¨ê³„ ì—…ë°ì´íŠ¸
        function updateWorkflowStep(stepNumber, status) {
            const step = document.getElementById(`workflow-step-${stepNumber}`);
            step.className = `workflow-step ${status}`;
        }
        
        // ì›Œí¬í”Œë¡œìš° ì´ˆê¸°í™”
        function resetWorkflow() {
            updateWorkflowStep(1, 'active');
            updateWorkflowStep(2, '');
            updateWorkflowStep(3, '');
        }
        
        // === ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ ===
        
        // ì „ì²´ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ (í•™êµ â†’ ìœ„ì¹˜ â†’ ë‚ ì”¨)
        async function runFullWorkflow() {
            if (!selectedSchoolData) {
                alert('ë¨¼ì € í•™êµë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const responseArea = document.getElementById('workflow-response');
            showResponse(responseArea, 'ì „ì²´ í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤...', 'loading');
            
            try {
                // 1ë‹¨ê³„: ìœ„ì¹˜ ì •ë³´ ì¡°íšŒ
                updateWorkflowStep(2, 'processing');
                await new Promise(resolve => setTimeout(resolve, 500)); // UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ë”œë ˆì´
                
                const locationResponse = await fetch(`${SUPABASE_URL}/functions/v1/geocode-address`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        address: selectedSchoolData.ORG_RDNMA
                    })
                });

                const locationResult = await locationResponse.json();
                
                if (!locationResponse.ok || !locationResult.success) {
                    throw new Error('ìœ„ì¹˜ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
                }
                
                currentLocationData = locationResult.location;
                displayLocationInfo(currentLocationData);
                updateWorkflowStep(2, 'completed');
                
                // 2ë‹¨ê³„: ë‚ ì”¨ ì •ë³´ ì¡°íšŒ
                updateWorkflowStep(3, 'processing');
                await new Promise(resolve => setTimeout(resolve, 500)); // UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ë”œë ˆì´
                
                const weatherResponse = await fetch(`${SUPABASE_URL}/functions/v1/get-weather-by-grid`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lat: currentLocationData.latitude,
                        lng: currentLocationData.longitude,
                        address: selectedSchoolData.SCHUL_NM
                    })
                });

                const weatherResult = await weatherResponse.json();
                
                if (!weatherResponse.ok || !weatherResult.success) {
                    throw new Error('ë‚ ì”¨ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
                }
                
                currentWeatherData = weatherResult.weather;
                displayWeatherInfo(currentWeatherData);
                updateWorkflowStep(3, 'completed');
                
                // ëª¨ë“  ë²„íŠ¼ í™œì„±í™”
                document.getElementById('get-location-btn').disabled = false;
                document.getElementById('get-weather-btn').disabled = false;
                
                showResponse(responseArea, 'âœ… ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ!\ní•™êµ â†’ ìœ„ì¹˜ â†’ ë‚ ì”¨ ì •ë³´ë¥¼ ëª¨ë‘ ì¡°íšŒí–ˆìŠµë‹ˆë‹¤.', 'success');
                
            } catch (error) {
                showResponse(responseArea, `âŒ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜!\n\n${error.message}`, 'error');
                console.error('Full workflow error:', error);
            }
        }
    </script>
</body>
</html>

/**
 * ë‚ ì”¨ ê¸°ë°˜ ê³µì§€ì‚¬í•­ ìƒì„± ì„œë¹„ìŠ¤
 * 
 * ì‚¬ìš©ìì˜ í•™êµ ìœ„ì¹˜ ë‚ ì”¨ë¥¼ ê¸°ë°˜ìœ¼ë¡œ
 * ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì ì ˆí•œ ë‚ ì”¨ ë¬¸êµ¬ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
 */

import type { Notice, Category } from '../data/notices'
import { WeatherService, type WeatherData } from './weatherService'
import { NoticeService } from './noticeService'

export class WeatherNoticeService {
  
  /**
   * ì‚¬ìš©ì í•™êµ ìœ„ì¹˜ ê¸°ë°˜ ë‚ ì”¨ ê³µì§€ì‚¬í•­ ìƒì„±
   */
  static async generateWeatherNotices(schoolLat: number, schoolLng: number): Promise<Notice[]> {
    console.log('ğŸŒ¤ï¸ğŸ“ ë‚ ì”¨ ê¸°ë°˜ ê³µì§€ì‚¬í•­ ìƒì„± ì‹œì‘')
    
    try {
      // 1. ë‚ ì”¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      const weather = await WeatherService.getWeatherByLocation(schoolLat, schoolLng)
      if (!weather) {
        console.warn('ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ê³µì§€ì‚¬í•­ì„ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')
        return []
      }
      
      console.log(`ğŸŒ¤ï¸ğŸ“ í˜„ì¬ ë‚ ì”¨: ${weather.condition}, ${weather.temperature}Â°C, ìŠµë„ ${weather.humidity}%, í’ì† ${weather.windSpeed}m/s`)
      
      // 2. ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë‚ ì”¨ ë¬¸êµ¬ë“¤ ì¡°íšŒ
      const weatherNotices = await NoticeService.getNotices({
        weatherNoticesOnly: true
      })
      
      // 3. ì¡°ê±´ì— ë§ëŠ” ë¬¸êµ¬ í•„í„°ë§
      const matchingNotices = weatherNotices.filter(notice => 
        this.isWeatherConditionMatch(weather, notice.weather_conditions)
      )
      
      console.log(`ğŸŒ¤ï¸ğŸ“ ì¡°ê±´ì— ë§ëŠ” ë‚ ì”¨ ë¬¸êµ¬ ${matchingNotices.length}ê°œ ë°œê²¬`)
      
      // 4. ìƒìœ„ 3ê°œë§Œ ë°˜í™˜
      return matchingNotices.slice(0, 3)
      
    } catch (error) {
      console.error('ğŸŒ¤ï¸ğŸ“ ë‚ ì”¨ ê¸°ë°˜ ê³µì§€ì‚¬í•­ ìƒì„± ì‹¤íŒ¨:', error)
      return []
    }
  }

  /**
   * ë‚ ì”¨ ì¡°ê±´ì´ ë¬¸êµ¬ ì¡°ê±´ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
   */
  private static isWeatherConditionMatch(weather: WeatherData, conditions: any): boolean {
    if (!conditions) return false
    
    // ì˜¨ë„ ì¡°ê±´ ì²´í¬
    if (conditions.temperature) {
      if (conditions.temperature.min && weather.temperature < conditions.temperature.min) {
        return false
      }
      if (conditions.temperature.max && weather.temperature > conditions.temperature.max) {
        return false
      }
    }
    
    // ë‚ ì”¨ ìƒíƒœ ì¡°ê±´ ì²´í¬
    if (conditions.condition && !conditions.condition.includes(weather.condition)) {
      return false
    }
    
    // í’ì† ì¡°ê±´ ì²´í¬
    if (conditions.windSpeed?.min && weather.windSpeed < conditions.windSpeed.min) {
      return false
    }

    // ìŠµë„ ì¡°ê±´ ì²´í¬
    if (conditions.humidity?.min && weather.humidity < conditions.humidity.min) {
      return false
    }
    
    return true
  }

  /**
   * ë‚ ì”¨ ê¸°ë°˜ í‚¤ì›Œë“œ ìƒì„± (ì°¸ê³ ìš©)
   */
  static generateWeatherKeywords(weather: WeatherData): string[] {
    const keywords: string[] = []

    // ì˜¨ë„ ê¸°ë°˜ í‚¤ì›Œë“œ
    if (weather.temperature >= 30) {
      keywords.push('í­ì—¼', 'ë”ìœ„', 'ìˆ˜ë¶„ì„­ì·¨', 'ê·¸ëŠ˜', 'íœ´ì‹')
    } else if (weather.temperature >= 25) {
      keywords.push('ë¬´ë”ìœ„', 'ì‹œì›í•¨', 'ë¬¼ë§ˆì‹œê¸°')
    } else if (weather.temperature <= 5) {
      keywords.push('í•œíŒŒ', 'ì¶”ìœ„', 'ë³´ì˜¨', 'ë”°ëœ»í•¨')
    } else if (weather.temperature <= 10) {
      keywords.push('ì¶”ìœ„', 'ì™¸íˆ¬', 'ì²´ì˜¨ìœ ì§€')
    }

    // ë‚ ì”¨ ìƒíƒœ ê¸°ë°˜ í‚¤ì›Œë“œ
    if (weather.condition.includes('ë¹„')) {
      keywords.push('ìš°ì‚°', 'ë¯¸ë„ëŸ¬ì§', 'ì•ˆì „', 'ìš°ë¹„')
    }
    if (weather.condition.includes('ëˆˆ')) {
      keywords.push('ëˆˆê¸¸', 'ë¯¸ë„ëŸ¬ì§', 'ë³´ì˜¨', 'ì•ˆì „')
    }

    // ë°”ëŒ ê¸°ë°˜ í‚¤ì›Œë“œ
    if (weather.windSpeed >= 8) {
      keywords.push('ê°•í’', 'ì•ˆì „', 'ê³ ì •', 'ì£¼ì˜')
    }

    // ìŠµë„ ê¸°ë°˜ í‚¤ì›Œë“œ
    if (weather.humidity >= 80) {
      keywords.push('ìŠµë„', 'í™˜ê¸°', 'ì¾Œì ', 'ìœ„ìƒ')
    }

    return keywords
  }
      
      console.log(`ğŸŒ¤ï¸ğŸ“ ë‚ ì”¨ ê¸°ë°˜ ê³µì§€ì‚¬í•­ ${notices.length}ê°œ ìƒì„± ì™„ë£Œ`)
      return notices
      
    } catch (error) {
      console.error('ğŸŒ¤ï¸ğŸ“ ë‚ ì”¨ ê¸°ë°˜ ê³µì§€ì‚¬í•­ ìƒì„± ì‹¤íŒ¨:', error)
      return []
    }
  }
  
  /**
   * ë‚ ì”¨ ì¡°ê±´ì— ë”°ë¥¸ í…œí”Œë¦¿ ì„ íƒ
   */
  private static selectWeatherTemplates(weather: WeatherData, conditions: any): WeatherNoticeTemplate[] {
    const templates: WeatherNoticeTemplate[] = []
    
    // í­ì—¼ ì£¼ì˜ë³´
    if (weather.temperature >= 33) {
      const heatTemplates = [
        {
          id: 'heat_01',
          title: 'ğŸŒ¡ï¸ í­ì—¼ ì£¼ì˜ë³´ ë°œë ¹',
          content: `ì˜¤ëŠ˜ ê¸°ì˜¨ì´ ${weather.temperature}Â°Cê¹Œì§€ ì˜¬ë¼ê°ˆ ì˜ˆì •ì…ë‹ˆë‹¤. í­ì—¼ìœ¼ë¡œ ì¸í•œ ì˜¨ì—´ì§ˆí™˜ ì˜ˆë°©ì— ê°ë³„íˆ ì£¼ì˜í•´ì£¼ì„¸ìš”.`,
          subItems: [
            'ì¶©ë¶„í•œ ìˆ˜ë¶„ ì„­ì·¨í•˜ê¸°',
            'ì™¸ì¶œ ì‹œ ì–‘ì‚°ì´ë‚˜ ëª¨ì ì°©ìš©',
            'ë¬´ë¦¬í•œ ì•¼ì™¸í™œë™ ìì œ',
            'ì‹œì›í•œ ê·¸ëŠ˜ì—ì„œ íœ´ì‹',
            'ëª¸ì— ì´ìƒ ì¦ìƒ ì‹œ ì¦‰ì‹œ ë³´ê±´ì‹¤ ë°©ë¬¸'
          ],
          tags: ['ì•ˆì „', 'ê±´ê°•', 'ì•Œë¦¼'] as Category[],
          priority: 1,
          icon: 'ğŸŒ¡ï¸'
        },
        {
          id: 'heat_02', 
          title: 'â˜€ï¸ ë¬´ë”ìœ„ íŠ¹ë³´ - ê±´ê°•ê´€ë¦¬ í•„ìˆ˜',
          content: `í˜„ì¬ ê¸°ì˜¨ ${weather.temperature}Â°C, ì²´ê°ì˜¨ë„ ${weather.feelsLike}Â°Cì˜ ë¬´ë”ìœ„ê°€ ê³„ì†ë©ë‹ˆë‹¤. í•™ìƒ ì—¬ëŸ¬ë¶„ì˜ ê±´ê°•ì„ ìœ„í•´ ë‹¤ìŒ ì‚¬í•­ì„ ì§€ì¼œì£¼ì„¸ìš”.`,
          subItems: [
            'ë¬¼ì„ ìì£¼ ë§ˆì‹œê¸° (ê°ˆì¦ì„ ëŠë¼ê¸° ì „ì—)',
            'ë•€ì„ ë§ì´ í˜ë ¸ë‹¤ë©´ ì´ì˜¨ìŒë£Œ ì„­ì·¨',
            'ì ì‹¬ì‹œê°„ ì™¸ë¶€í™œë™ ìµœì†Œí™”',
            'êµì‹¤ ì—ì–´ì»¨ ì ì •ì˜¨ë„ ìœ ì§€',
            'ì–´ì§€ëŸ½ê±°ë‚˜ ë©”ìŠ¤êº¼ìš°ë©´ ì¦‰ì‹œ ì‹ ê³ '
          ],
          tags: ['ê±´ê°•', 'ìƒí™œì§€ë„', 'ì£¼ì˜'] as Category[],
          priority: 1,
          icon: 'â˜€ï¸'
        },
        {
          id: 'heat_03',
          title: 'ğŸ”¥ ê·¹ì‹¬í•œ ë”ìœ„ - ì•ˆì „ìˆ˜ì¹™ ì¤€ìˆ˜',
          content: `ì˜¤ëŠ˜ ìµœê³ ê¸°ì˜¨ì´ ${weather.temperature}Â°Cë¡œ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤. ì—´ì‚¬ë³‘ê³¼ íƒˆìˆ˜ ì˜ˆë°©ì„ ìœ„í•´ ì•ˆì „ìˆ˜ì¹™ì„ ì² ì €íˆ ì§€ì¼œì£¼ì„¸ìš”.`,
          subItems: [
            '30ë¶„ë§ˆë‹¤ ë¬¼ í•œ ì»µì”© ë§ˆì‹œê¸°',
            'ì²´ìœ¡ì‹œê°„ ê°•ë„ ì¡°ì ˆ',
            'ê·¸ëŠ˜ì§„ ê³³ì—ì„œ í™œë™í•˜ê¸°',
            'ëƒ‰ë°©ì‹œì„¤ ì ê·¹ ì´ìš©',
            'ë‘í†µÂ·í˜„ê¸°ì¦ ì‹œ ì¦‰ì‹œ íœ´ì‹'
          ],
          tags: ['ì•ˆì „', 'ì²´ìœ¡', 'ê±´ê°•'] as Category[],
          priority: 1,
          icon: 'ğŸ”¥'
        }
      ]
      const randomIndex = Math.floor(Math.random() * heatTemplates.length)
      templates.push(heatTemplates[randomIndex])
    }
    
    // í•œíŒŒ ì£¼ì˜ë³´
    else if (weather.temperature <= 0) {
      const coldTemplates = [
        {
          id: 'cold_01',
          title: 'â„ï¸ í•œíŒŒ íŠ¹ë³´ ë°œë ¹',
          content: `ì˜¤ëŠ˜ ê¸°ì˜¨ì´ ${weather.temperature}Â°Cë¡œ ë§¤ìš° ì¶¥ìŠµë‹ˆë‹¤. ë™ìƒê³¼ ê°ê¸° ì˜ˆë°©ì„ ìœ„í•´ ë³´ì˜¨ì— ì‹ ê²½ì¨ì£¼ì„¸ìš”.`,
          subItems: [
            'ì™¸ì¶œ ì‹œ ë‘êº¼ìš´ ì™¸íˆ¬ ì°©ìš©',
            'ëª©ë„ë¦¬, ì¥ê°‘, ëª¨ì ì¤€ë¹„',
            'ì‹¤ë‚´ì™¸ ì˜¨ë„ì°¨ë¡œ ì¸í•œ ê°ê¸° ì£¼ì˜',
            'ë”°ëœ»í•œ ìŒë£Œ ì„­ì·¨',
            'ì –ì€ ì˜·ì€ ì¦‰ì‹œ ê°ˆì•„ì…ê¸°'
          ],
          tags: ['ì•ˆì „', 'ê±´ê°•', 'ì•Œë¦¼'] as Category[],
          priority: 1,
          icon: 'â„ï¸'
        },
        {
          id: 'cold_02',
          title: 'ğŸ§Š ê·¹í•œ ì¶”ìœ„ - ì²´ì˜¨ ìœ ì§€ í•„ìˆ˜',
          content: `í˜„ì¬ ê¸°ì˜¨ ${weather.temperature}Â°C, ì²´ê°ì˜¨ë„ëŠ” ë”ìš± ë‚®ìŠµë‹ˆë‹¤. ë™ìƒ ìœ„í—˜ì´ ìˆìœ¼ë‹ˆ ê°ë³„í•œ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.`,
          subItems: [
            'ì–‡ì€ ì˜·ì„ ì—¬ëŸ¬ ê²¹ ì°©ìš©',
            'ì†ê³¼ ë°œë ë³´ì˜¨ ì² ì €íˆ',
            'ì•¼ì™¸í™œë™ ì‹œê°„ ë‹¨ì¶•',
            'ì‹¤ë‚´ í™œë™ ëŠ˜ë¦¬ê¸°',
            'ë”°ëœ»í•œ ë¬¼ë¡œ ì† ì”»ê¸°'
          ],
          tags: ['ì•ˆì „', 'ìƒí™œì§€ë„', 'ì£¼ì˜'] as Category[],
          priority: 1,
          icon: 'ğŸ§Š'
        }
      ]
      const randomIndex = Math.floor(Math.random() * coldTemplates.length)
      templates.push(coldTemplates[randomIndex])
    }
    
    // ë¹„/ìš°ì²œ ì‹œ
    else if (conditions.isRaining) {
      const rainTemplates = [
        {
          id: 'rain_01',
          title: 'ğŸŒ§ï¸ ìš°ì²œ ì‹œ ì•ˆì „ìˆ˜ì¹™',
          content: `ë¹„ê°€ ë‚´ë¦¬ê³  ìˆìŠµë‹ˆë‹¤. ë¯¸ë„ëŸ¬ì§ ì‚¬ê³  ì˜ˆë°©ê³¼ ì•ˆì „í•œ ë“±í•˜êµë¥¼ ìœ„í•´ ë‹¤ìŒ ì‚¬í•­ì„ ì§€ì¼œì£¼ì„¸ìš”.`,
          subItems: [
            'ìš°ì‚° ë˜ëŠ” ìš°ë¹„ ì°©ìš©',
            'ë³µë„ì™€ ê³„ë‹¨ì—ì„œ ì²œì²œíˆ ê±·ê¸°',
            'ì‹ ë°œ ë°‘ì°½ ë¬¼ê¸° ì œê±°',
            'ì –ì€ ìš°ì‚°ì€ ì§€ì •ëœ ê³³ì— ë³´ê´€',
            'ì°¨ë„ì—ì„œ ë–¨ì–´ì ¸ ê±·ê¸°'
          ],
          tags: ['ì•ˆì „', 'êµí†µ', 'ì•Œë¦¼'] as Category[],
          priority: 2,
          icon: 'ğŸŒ§ï¸'
        },
        {
          id: 'rain_02',
          title: 'â˜” ë¹„ì˜¤ëŠ” ë‚  ìƒí™œìˆ˜ì¹™',
          content: `ìš°ì²œìœ¼ë¡œ ì¸í•´ ì‹¤ì™¸í™œë™ì´ ì œí•œë©ë‹ˆë‹¤. ì‹¤ë‚´ì—ì„œ ì•ˆì „í•˜ê³  ì˜ë¯¸ìˆëŠ” ì‹œê°„ì„ ë³´ë‚´ë„ë¡ í•©ì‹œë‹¤.`,
          subItems: [
            'ìš°ì‚° ì±™ê¸°ê³  ë“±í•˜êµ',
            'ë¬¼ì›…ë©ì´ í”¼í•´ ë‹¤ë‹ˆê¸°',
            'ì‹¤ë‚´í™”ë¡œ ê°ˆì•„ì‹ ê¸°',
            'ì –ì€ ë¬¼ê±´ ì˜ ë§ë¦¬ê¸°',
            'ë…ì„œë‚˜ ì‹¤ë‚´ê²Œì„ ì¦ê¸°ê¸°'
          ],
          tags: ['ìƒí™œì§€ë„', 'ì•Œë¦¼'] as Category[],
          priority: 2,
          icon: 'â˜”'
        }
      ]
      const randomIndex = Math.floor(Math.random() * rainTemplates.length)
      templates.push(rainTemplates[randomIndex])
    }
    
    // ê°•í’ ì£¼ì˜
    else if (conditions.isWindy) {
      templates.push({
        id: 'wind_01',
        title: 'ğŸ’¨ ê°•í’ ì£¼ì˜ë³´',
        content: `ê°•í•œ ë°”ëŒì´ ë¶ˆê³  ìˆìŠµë‹ˆë‹¤ (í’ì† ${weather.windSpeed.toFixed(1)}m/s). ë‚™í•˜ë¬¼ê³¼ ë‚ ì•„ì˜¤ëŠ” ë¬¼ê±´ì— ì£¼ì˜í•´ì£¼ì„¸ìš”.`,
        subItems: [
          'ê±´ë¬¼ ì£¼ë³€ ë‚™í•˜ë¬¼ ì£¼ì˜',
          'ìš°ì‚° ì‚¬ìš© ì‹œ ì¡°ì‹¬',
          'ëª¨ìë‚˜ ê°€ë²¼ìš´ ë¬¼ê±´ ë‹¨ë‹¨íˆ ê³ ì •',
          'ì•¼ì™¸í™œë™ ìì œ',
          'ì•ˆì „í•œ ê³³ì—ì„œ ëŒ€ê¸°'
        ],
        tags: ['ì•ˆì „', 'ì£¼ì˜', 'ì•Œë¦¼'] as Category[],
        priority: 2,
        icon: 'ğŸ’¨'
      })
    }
    
    // ë”ìš´ ë‚ ì”¨ (í­ì—¼ì€ ì•„ë‹˜)
    else if (conditions.isHot) {
      const hotTemplates = [
        {
          id: 'hot_01',
          title: 'ğŸŒ ë¬´ë”ìœ„ ì•ˆì „ìˆ˜ì¹™',
          content: `ì˜¤ëŠ˜ ê¸°ì˜¨ì´ ${weather.temperature}Â°Cë¡œ ë”ì›Œì§ˆ ì˜ˆì •ì…ë‹ˆë‹¤. ê±´ê°•í•œ í•˜ë£¨ë¥¼ ìœ„í•´ ë”ìœ„ ì˜ˆë°©ë²•ì„ ì‹¤ì²œí•´ì£¼ì„¸ìš”.`,
          subItems: [
            'ë¬¼ì„ ì¶©ë¶„íˆ ë§ˆì‹œê¸°',
            'ê·¸ëŠ˜ì—ì„œ íœ´ì‹í•˜ê¸°',
            'ê°€ë²¼ìš´ ì˜·ì°¨ë¦¼',
            'ê³¼ë„í•œ ìš´ë™ í”¼í•˜ê¸°',
            'ì‹œì›í•œ ê³³ì—ì„œ í™œë™'
          ],
          tags: ['ê±´ê°•', 'ìƒí™œì§€ë„'] as Category[],
          priority: 3,
          icon: 'ğŸŒ'
        },
        {
          id: 'hot_02',
          title: 'ğŸŒ» ë”ìš´ ë‚ ì”¨ ê±´ê°•ê´€ë¦¬',
          content: `ë”°ëœ»í•œ ë‚ ì”¨ì…ë‹ˆë‹¤ (${weather.temperature}Â°C). í™œë™ì ì¸ í•˜ë£¨ë¥¼ ë³´ë‚´ë˜ ê±´ê°•ê´€ë¦¬ë„ í•¨ê»˜ í•´ì£¼ì„¸ìš”.`,
          subItems: [
            'ìˆ˜ë¶„ ë³´ì¶© ìì£¼í•˜ê¸°',
            'ëª¨ìë‚˜ ì–‘ì‚° í™œìš©',
            'ì ì‹¬ì‹œê°„ ê·¸ëŠ˜ ì´ìš©',
            'ëƒ‰ë°©ê¸° ì ì ˆíˆ ì‚¬ìš©',
            'ëª¸ì˜ ì‹ í˜¸ ê·€ê¸°ìš¸ì´ê¸°'
          ],
          tags: ['ê±´ê°•', 'ì•Œë¦¼'] as Category[],
          priority: 3,
          icon: 'ğŸŒ»'
        }
      ]
      const randomIndex = Math.floor(Math.random() * hotTemplates.length)
      templates.push(hotTemplates[randomIndex])
    }
    
    return templates
  }
  
  /**
   * í…œí”Œë¦¿ì„ Notice í˜•íƒœë¡œ ë³€í™˜
   */
  private static createNoticeFromTemplate(template: WeatherNoticeTemplate, weather: WeatherData): Notice {
    const now = new Date()
    
    return {
      id: `weather_${template.id}_${now.getTime()}`,
      title: template.title,
      content: template.content,
      tags: template.tags,
      author: 'ğŸ¤– ë‚ ì”¨ ê¸°ë°˜ ìƒì„±',
      likeCount: 0,
      subItems: template.subItems,
      createdAt: now,
      isRecommended: template.priority <= 2, // ìš°ì„ ìˆœìœ„ 1,2ëŠ” ì¶”ì²œìœ¼ë¡œ í‘œì‹œ
      isPopular: false,
      usageCount: 0
    }
  }
  
  /**
   * ë‚ ì”¨ ì•„ì´ì½˜ ë°˜í™˜
   */
  static getWeatherIcon(condition: string): string {
    const iconMap: Record<string, string> = {
      'ë§‘ìŒ': 'â˜€ï¸',
      'êµ¬ë¦„ë§ìŒ': 'â›…',
      'íë¦¼': 'â˜ï¸', 
      'ë¹„': 'ğŸŒ§ï¸',
      'ì†Œë‚˜ê¸°': 'ğŸŒ¦ï¸',
      'ëˆˆ': 'â„ï¸',
      'ì•ˆê°œ': 'ğŸŒ«ï¸',
      'ë‡Œìš°': 'â›ˆï¸'
    }
    
    return iconMap[condition] || 'ğŸŒ¤ï¸'
  }
  
  /**
   * ë‚ ì”¨ ìƒíƒœ ë©”ì‹œì§€ ìƒì„±
   */
  static generateWeatherStatusMessage(weather: WeatherData): string {
    const icon = this.getWeatherIcon(weather.condition)
    return `${icon} ${weather.condition} ${weather.temperature}Â°C (${weather.location})`
  }
}
